<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Checker - Управление списками</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 20px;
        }
        .btn-custom {
            border-radius: 25px;
            padding: 10px 25px;
        }
        .status-processed {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
        }
        .status-pending {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
        }
        .file-size {
            color: #6c757d;
            font-size: 0.9em;
        }
        .action-buttons .btn {
            margin: 2px;
        }
        .modal-header {
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
        }
        .processing-log {
            background: #2d3748;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .processing-log .text-muted {
            color: #718096 !important;
        }

        /* Checkbox dropdown menu styles */
        .checkbox-menu {
            max-height: 300px;
            overflow-y: auto;
        }
        .checkbox-menu .form-check {
            padding: 4px 8px;
            margin-bottom: 5px;
        }
        .checkbox-menu .form-check:hover {
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .checkbox-menu .form-check-label {
            cursor: pointer;
            width: 100%;
            user-select: none;
        }
        .checkbox-menu hr {
            margin: 8px 0;
        }

        /* Upload zone styles */
        .upload-zone {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-zone:hover {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        .upload-zone.dragover {
            border-color: #28a745;
            background-color: #d4edda;
            transform: scale(1.02);
        }
        .upload-result-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .upload-result-item.success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        .upload-result-item.error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="text-center"><i class="fas fa-envelope-open-text"></i> Email Checker - Управление списками</h1>
            <p class="text-center lead">Настройка метаданных и запуск обработки</p>
        </div>
    </div>

    <div class="container">
        <!-- Панель управления -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-3 align-items-center">
                            <button class="btn btn-success btn-custom" onclick="loadLists()">
                                <i class="fas fa-sync-alt"></i> Обновить списки
                            </button>
                            <button class="btn btn-primary btn-custom" onclick="runProcessing()">
                                <i class="fas fa-play"></i> Запустить обработку
                            </button>
                            <button class="btn btn-info btn-custom" onclick="showReport()">
                                <i class="fas fa-chart-line"></i> Показать отчет
                            </button>
                            <button class="btn btn-warning btn-custom" onclick="resetProcessing()">
                                <i class="fas fa-trash-alt"></i> Сбросить обработку
                            </button>
                            <button class="btn btn-secondary btn-custom" onclick="showMetadataManager()">
                                <i class="fas fa-cogs"></i> Управление метаданными
                            </button>
                            <button class="btn btn-warning btn-custom" onclick="showBatchEditModal()">
                                <i class="fas fa-edit"></i> Массовое редактирование
                            </button>
                            <button class="btn btn-info btn-custom" onclick="showEnrichmentManager()">
                                <i class="fas fa-plus-circle"></i> Обогащение списков
                            </button>
                            <button class="btn btn-primary btn-custom" onclick="showLVPImportManager()">
                                <i class="fas fa-file-import"></i> Импорт LVP
                            </button>
                            <button class="btn btn-danger btn-custom" onclick="showAdminPanel()">
                                <i class="fas fa-tools"></i> Админ-панель
                            </button>
                            <a href="/new" class="btn btn-outline-primary btn-custom" style="border: 2px solid #007bff;">
                                <i class="fas fa-rocket"></i> Новый интерфейс
                            </a>
                            <div class="ms-auto">
                                <select class="form-select" id="filterCategory" onchange="applyFilters()">
                                    <option value="">Все категории</option>
                                    <option value="General">General</option>
                                    <option value="Business">Business</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Services">Services</option>
                                    <option value="Regional">Regional</option>
                                </select>
                            </div>
                            <div>
                                <select class="form-select" id="filterCountry" onchange="applyFilters()">
                                    <option value="">Все страны</option>
                                    <option value="Mixed">Mixed</option>
                                    <option value="Europe">Europe</option>
                                    <option value="Germany">Germany</option>
                                    <option value="Poland">Poland</option>
                                    <option value="Sweden">Sweden</option>
                                    <option value="Unknown">Unknown</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Настройки обработки -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-sliders-h"></i> Настройки обработки</h6>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label"><i class="fas fa-cog"></i> Режим обработки</label>
                                <select class="form-select" id="processingMode">
                                    <option value="check-all-incremental" selected>Инкрементальная (TXT+LVP) - Рекомендуется</option>
                                    <option value="batch">Полная обработка (без кеша)</option>
                                    <option value="incremental">Инкрементальная (только TXT) - Legacy</option>
                                </select>
                                <small class="text-muted">Инкрементальный режим обрабатывает только новые/измененные файлы</small>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="excludeDuplicates" checked>
                                    <label class="form-check-label" for="excludeDuplicates">
                                        <i class="fas fa-filter"></i> Исключать дубликаты
                                    </label>
                                </div>
                                <small class="text-muted">Убирает email, которые уже были в предыдущих списках</small>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="generateHtml" checked>
                                    <label class="form-check-label" for="generateHtml">
                                        <i class="fas fa-chart-bar"></i> Генерировать HTML отчет
                                    </label>
                                </div>
                                <small class="text-muted">Создает визуальный отчет со статистикой и графиками</small>
                            </div>
                            <div class="col-md-3">
                                <div class="mt-4">
                                    <span class="badge bg-info" id="estimatedMode">
                                        <i class="fas fa-info-circle"></i> Обработка: ~1-2 секунды на 7K emails
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Загрузка файлов -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> Загрузка файлов</h6>
                    </div>
                    <div class="card-body">
                        <div id="uploadZone" class="upload-zone text-center p-5" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                            <h5>Перетащите файлы сюда или нажмите для выбора</h5>
                            <p class="text-muted">Поддерживаются форматы: .txt, .lvp (макс. 100MB)</p>
                            <input type="file" id="fileInput" multiple accept=".txt,.lvp" style="display: none;" onchange="handleFileSelect(event)">
                        </div>
                        <div id="uploadProgress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <p class="text-center mt-2" id="uploadStatus"></p>
                        </div>
                        <div id="uploadResults" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статистика -->
        <div class="row mb-4" id="statsRow">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3 id="totalLists">0</h3>
                        <p>Всего списков</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3 id="processedLists">0</h3>
                        <p>Обработано</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h3 id="pendingLists">0</h3>
                        <p>Ожидает</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h3 id="totalSize">0</h3>
                        <p>Общий размер</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Таблица списков -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Email списки</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Файл</th>
                                <th>Название</th>
                                <th>Страна</th>
                                <th>Категория</th>
                                <th>Размер</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="listsTable">
                            <!-- Списки будут загружены динамически -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Email Metadata Viewer -->
        <div class="row mb-4" id="emailMetadataSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-envelope-open-text"></i> Email Metadata Viewer</h5>
                            <button class="btn btn-sm btn-secondary" onclick="hideEmailMetadata()">
                                <i class="fas fa-times"></i> Скрыть
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Email Search and Filter -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label small mb-1">Поиск по email</label>
                                <input type="text" class="form-control" id="emailSearch" placeholder="Введите email..." onkeyup="debounceSearch()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small mb-1">Фильтр по списку</label>
                                <select class="form-select" id="sourceFileFilter" onchange="filterEmails()">
                                    <option value="">Все списки</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Статус валидации</label>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100 text-start"
                                            type="button"
                                            id="validationFilterDropdown"
                                            data-bs-toggle="dropdown"
                                            data-bs-auto-close="outside"
                                            aria-expanded="false">
                                        <span id="validationFilterLabel">Все</span>
                                    </button>
                                    <div class="dropdown-menu checkbox-menu p-2" aria-labelledby="validationFilterDropdown" style="min-width: 200px;">
                                        <div class="form-check">
                                            <input class="form-check-input validation-status-checkbox" type="checkbox" value="Valid" id="statusValid" onchange="updateValidationFilter()">
                                            <label class="form-check-label" for="statusValid">Valid</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input validation-status-checkbox" type="checkbox" value="NotSure" id="statusNotSure" onchange="updateValidationFilter()">
                                            <label class="form-check-label" for="statusNotSure">NotSure</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input validation-status-checkbox" type="checkbox" value="Temp" id="statusTemp" onchange="updateValidationFilter()">
                                            <label class="form-check-label" for="statusTemp">Temp</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input validation-status-checkbox" type="checkbox" value="Invalid" id="statusInvalid" onchange="updateValidationFilter()">
                                            <label class="form-check-label" for="statusInvalid">Invalid</label>
                                        </div>
                                        <hr class="my-2">
                                        <button class="btn btn-sm btn-outline-primary w-100" onclick="invertStatusSelection()">
                                            <i class="fas fa-exchange-alt"></i> Инвертировать
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mt-1" onclick="clearStatusSelection()">
                                            <i class="fas fa-times"></i> Очистить
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Страна</label>
                                <select class="form-select" id="countryFilter" onchange="filterEmails()">
                                    <option value="">Все</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Категория</label>
                                <select class="form-select" id="categoryFilter" onchange="filterEmails()">
                                    <option value="">Все</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Наличие телефона</label>
                                <select class="form-select" id="phoneFilter" onchange="filterEmails()">
                                    <option value="">Все</option>
                                    <option value="true">С телефоном</option>
                                    <option value="false">Без телефона</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1">Несоответствие стран</label>
                                <select class="form-select" id="countryMismatchFilter" onchange="filterEmails()">
                                    <option value="">Все</option>
                                    <option value="true">Только несоответствия</option>
                                    <option value="false">Без несоответствий</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1">&nbsp;</label>
                                <div>
                                    <span class="badge bg-primary" id="emailCount">0 emails</span>
                                    <span class="spinner-border spinner-border-sm text-primary ms-2" id="loadingSpinner" style="display: none;"></span>
                                </div>
                            </div>
                            <div class="col-md-7 text-end">
                                <label class="form-label small mb-1">&nbsp;</label>
                                <div id="activeFilters"></div>
                            </div>
                        </div>

                        <!-- Advanced Search Button -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <button class="btn btn-outline-primary btn-sm" onclick="showAdvancedFilters()">
                                    <i class="fas fa-filter"></i> Расширенные фильтры
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearAllFilters()">
                                    <i class="fas fa-times"></i> Очистить фильтры
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="exportFilteredResults()">
                                    <i class="fas fa-download"></i> Экспорт результатов
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="showLVPExportModal()">
                                    <i class="fas fa-file-export"></i> Экспорт в LVP
                                </button>
                            </div>
                        </div>

                        <!-- Email Metadata Table -->
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover table-sm">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th width="2%">#</th>
                                        <th width="18%">Email</th>
                                        <th width="10%">Domain</th>
                                        <th width="12%">Company</th>
                                        <th width="12%">Source File</th>
                                        <th width="8%">Country</th>
                                        <th width="7%">Phone</th>
                                        <th width="8%">Category</th>
                                        <th width="7%">Status</th>
                                        <th width="16%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="emailMetadataTable">
                                    <!-- Email metadata will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Email Details -->
    <div class="modal fade" id="emailDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle"></i> Email Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-envelope"></i> Email Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Email:</strong></td><td id="detailEmail"></td></tr>
                                <tr><td><strong>Domain:</strong></td><td id="detailDomain"></td></tr>
                                <tr><td><strong>Validation Status:</strong></td><td id="detailValidationStatus"></td></tr>
                                <tr><td><strong>Validation Date:</strong></td><td id="detailValidationDate"></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-building"></i> Company Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Company:</strong></td><td id="detailCompanyName"></td></tr>
                                <tr><td><strong>Phone:</strong></td><td id="detailPhone"></td></tr>
                                <tr><td><strong>Country:</strong></td><td id="detailCountry"></td></tr>
                                <tr><td><strong>City:</strong></td><td id="detailCity"></td></tr>
                                <tr><td><strong>Address:</strong></td><td id="detailAddress"></td></tr>
                                <tr><td><strong>Category:</strong></td><td id="detailCategory"></td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><i class="fas fa-globe"></i> Web Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Source URL:</strong></td><td id="detailSourceUrl"></td></tr>
                                <tr><td><strong>Page Title:</strong></td><td id="detailPageTitle"></td></tr>
                                <tr><td><strong>Keywords:</strong></td><td id="detailKeywords"></td></tr>
                                <tr><td><strong>Meta Description:</strong></td><td id="detailMetaDescription"></td></tr>
                                <tr><td><strong>Meta Keywords:</strong></td><td id="detailMetaKeywords"></td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><i class="fas fa-clipboard-list"></i> Validation Log</h6>
                            <pre class="bg-light p-3" style="max-height: 200px; overflow-y: auto; font-size: 0.8em;" id="detailValidationLog"></pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Редактирование списка</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editFilename">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Название отображения</label>
                                <input type="text" class="form-control" id="editDisplayName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Приоритет</label>
                                <input type="number" class="form-control" id="editPriority" min="1" required>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Страна</label>
                                <select class="form-control" id="editCountry">
                                    <option value="Unknown">Unknown</option>
                                    <option value="Mixed">Mixed</option>
                                    <option value="Belgium">Belgium</option>
                                    <option value="Bulgaria">Bulgaria</option>
                                    <option value="Czech Republic">Czech Republic</option>
                                    <option value="Europe">Europe</option>
                                    <option value="Germany">Germany</option>
                                    <option value="Poland">Poland</option>
                                    <option value="Russia">Russia</option>
                                    <option value="Sweden">Sweden</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Категория</label>
                                <select class="form-control" id="editCategory">
                                    <option value="General">General</option>
                                    <option value="Agriculture">Agriculture</option>
                                    <option value="Automotive">Automotive</option>
                                    <option value="Business">Business</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Regional">Regional</option>
                                    <option value="Services">Services</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Transportation">Transportation</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" id="editDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveChanges()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно обработки -->
    <div class="modal fade" id="processingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cogs"></i> Обработка списков</h5>
                </div>
                <div class="modal-body">
                    <div class="processing-log" id="processingLog">
                        Запуск обработки...\n
                    </div>
                    <div class="mt-3">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 id="progressBar" role="progressbar" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeProcessing" disabled>Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for LVP Export -->
    <div class="modal fade" id="lvpExportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-export"></i> Экспорт метаданных в LVP формат</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Экспорт метаданных email из базы данных в формат LVP (совместимый с импортом)</p>

                    <div class="mb-3">
                        <label class="form-label">Тип экспорта:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="lvpExportType" id="lvpExportAll" value="all" checked>
                            <label class="form-check-label" for="lvpExportAll">
                                Полный экспорт (все метаданные из базы данных)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="lvpExportType" id="lvpExportFiltered" value="filtered">
                            <label class="form-check-label" for="lvpExportFiltered">
                                Фильтрованный экспорт (применить текущие фильтры)
                            </label>
                        </div>
                    </div>

                    <div id="lvpFilterOptions" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Будут применены следующие активные фильтры:
                            <div id="lvpActiveFiltersDisplay" class="mt-2"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Лимит записей (опционально):</label>
                        <input type="number" class="form-control" id="lvpExportLimit" placeholder="Оставьте пустым для экспорта всех записей" min="1">
                        <small class="text-muted">Укажите максимальное количество записей для экспорта (полезно для тестирования)</small>
                    </div>

                    <div id="lvpExportProgress" style="display: none;">
                        <div class="alert alert-primary">
                            <i class="fas fa-spinner fa-spin"></i> Экспорт в процессе...
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="executeLVPExport()" id="lvpExportBtn">
                        <i class="fas fa-file-export"></i> Экспортировать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно управления метаданными -->
    <div class="modal fade" id="metadataModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cogs"></i> Управление метаданными</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Управление странами -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-globe"></i> Страны</h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="newCountry" placeholder="Новая страна">
                                        <button class="btn btn-success" onclick="addMetadata('country')">
                                            <i class="fas fa-plus"></i> Добавить
                                        </button>
                                    </div>
                                    <div class="list-container" style="max-height: 300px; overflow-y: auto;">
                                        <ul class="list-group" id="countriesList">
                                            <!-- Список стран будет загружен динамически -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Управление категориями -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-tags"></i> Категории</h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="newCategory" placeholder="Новая категория">
                                        <button class="btn btn-success" onclick="addMetadata('category')">
                                            <i class="fas fa-plus"></i> Добавить
                                        </button>
                                    </div>
                                    <div class="list-container" style="max-height: 300px; overflow-y: auto;">
                                        <ul class="list-group" id="categoriesList">
                                            <!-- Список категорий будет загружен динамически -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary" onclick="reloadMetadata()">
                        <i class="fas fa-sync-alt"></i> Обновить списки
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно расширенных фильтров -->
    <div class="modal fade" id="advancedFiltersModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-filter"></i> Расширенные фильтры</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="advancedEmailPattern" class="form-label">Шаблон email</label>
                                <input type="text" class="form-control" id="advancedEmailPattern" placeholder="Например: @gmail.com">
                                <small class="form-text text-muted">Поддерживает частичное совпадение</small>
                            </div>
                            <div class="mb-3">
                                <label for="advancedDomain" class="form-label">Домен</label>
                                <input type="text" class="form-control" id="advancedDomain" placeholder="Например: gmail.com">
                            </div>
                            <div class="mb-3">
                                <label for="advancedCompany" class="form-label">Компания</label>
                                <input type="text" class="form-control" id="advancedCompany" placeholder="Название компании">
                            </div>
                            <div class="mb-3">
                                <label for="advancedCity" class="form-label">Город</label>
                                <input type="text" class="form-control" id="advancedCity" placeholder="Название города">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="advancedValidationStatus" class="form-label">Статус валидации</label>
                                <select class="form-select" id="advancedValidationStatus">
                                    <option value="">Любой статус</option>
                                    <option value="Valid">Valid</option>
                                    <option value="NotSure">NotSure</option>
                                    <option value="Temp">Temp</option>
                                    <option value="Invalid">Invalid</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="advancedPhoneFilter" class="form-label">Наличие телефона</label>
                                <select class="form-select" id="advancedPhoneFilter">
                                    <option value="">Неважно</option>
                                    <option value="true">Есть телефон</option>
                                    <option value="false">Нет телефона</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="advancedLimit" class="form-label">Лимит результатов</label>
                                <select class="form-select" id="advancedLimit">
                                    <option value="100">100</option>
                                    <option value="500">500</option>
                                    <option value="1000" selected>1000</option>
                                    <option value="5000">5000</option>
                                    <option value="10000">10000</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="advancedSourceFile" class="form-label">Исходный файл</label>
                                <input type="text" class="form-control" id="advancedSourceFile" placeholder="Название файла">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-warning" onclick="clearAdvancedFilters()">Очистить</button>
                    <button type="button" class="btn btn-primary" onclick="applyAdvancedFilters()">Применить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно импорта LVP -->
    <div class="modal fade" id="lvpImportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-import"></i> Импорт LVP файлов с метаданными</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Статистика импорта -->
                        <div class="col-12 mb-4">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> Информация об LVP файлах</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="lvpFolderPath" class="form-label">Папка сканирования:</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="lvpFolderPath" value="/mnt/e/shtim/Downloads/">
                                            <button class="btn btn-outline-secondary" onclick="browseLVPFolder()">
                                                <i class="fas fa-folder-open"></i> Обзор
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2">Найдено LVP файлов: <strong id="lvpTotalFiles">0</strong></p>
                                        <p class="mb-2">Новых для импорта: <strong id="lvpNewFiles">0</strong></p>
                                        <p class="mb-0">Уже импортировано: <strong id="lvpImportedFiles">0</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Список доступных LVP файлов -->
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6><i class="fas fa-folder-open"></i> Доступные LVP файлы</h6>
                                    <div>
                                        <button class="btn btn-sm btn-success" onclick="importAllLVP()">
                                            <i class="fas fa-download"></i> Импортировать все новые
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="scanLVPFolder()">
                                            <i class="fas fa-sync-alt"></i> Обновить список
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="lvpFilesList">
                                        <!-- Список файлов будет загружен динамически -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Импортированные LVP файлы -->
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-check-circle"></i> Импортированные файлы</h6>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="lvpImportedList">
                                        <!-- Список импортированных файлов -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Прогресс импорта -->
                    <div class="row mt-3" id="lvpImportProgress" style="display: none;">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-spinner fa-spin"></i> Импорт в процессе...</h6>
                                    <div class="progress mb-2">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="lvpProgressBar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                    <div id="lvpImportLog" style="font-family: monospace; font-size: 0.8em; max-height: 200px; overflow-y: auto;">
                                        <!-- Лог импорта -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-warning" onclick="showLVPHelp()">
                        <i class="fas fa-question-circle"></i> Помощь
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно управления обогащением -->
    <div class="modal fade" id="enrichmentModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Обогащение списков метаданными</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Статистика обогащения -->
                        <div class="col-12 mb-4">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> Информация об обогащении</h6>
                                <p class="mb-2">В базе данных: <strong id="enrichmentTotalMetadata">10,794</strong> email с метаданными</p>
                                <p class="mb-0">Доступно для обогащения: <strong id="enrichmentPendingFiles">0</strong> списков с <strong id="enrichmentPendingEmails">0</strong> email</p>
                            </div>
                        </div>

                        <!-- Список файлов для обогащения -->
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6><i class="fas fa-list"></i> Доступные списки</h6>
                                    <div>
                                        <button class="btn btn-sm btn-success" onclick="enrichAllLists()">
                                            <i class="fas fa-magic"></i> Обогатить все
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="enrichAllLists(true)">
                                            <i class="fas fa-redo"></i> Переобогатить все
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="enrichmentFilesList">
                                        <!-- Список файлов будет загружен динамически -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Уже обогащенные файлы -->
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-check-circle"></i> Уже обогащенные</h6>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="enrichedFilesList">
                                        <!-- Список обогащенных файлов -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Прогресс обогащения -->
                    <div class="row mt-3" id="enrichmentProgress" style="display: none;">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-spinner fa-spin"></i> Обогащение в процессе...</h6>
                                    <div class="progress mb-2">
                                        <div class="progress-bar" id="enrichmentProgressBar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                    <div id="enrichmentLog" style="font-family: monospace; font-size: 0.8em; max-height: 200px; overflow-y: auto;">
                                        <!-- Лог обогащения -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary" onclick="refreshEnrichmentData()">
                        <i class="fas fa-sync-alt"></i> Обновить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно выбора папки LVP -->
    <div class="modal fade" id="folderBrowseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-folder-open"></i> Выбор папки для LVP файлов</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Навигация по папкам -->
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-folder"></i></span>
                            <input type="text" class="form-control" id="currentFolderPath" placeholder="/mnt/e/shtim/Downloads/"  onkeypress="handlePathKeyPress(event)">
                            <button class="btn btn-outline-secondary" onclick="navigateToParent()" id="parentButton">
                                <i class="fas fa-level-up-alt"></i> Вверх
                            </button>
                            <button class="btn btn-primary" onclick="loadCustomPath()" id="loadButton">
                                <i class="fas fa-folder-open"></i> Загрузить
                            </button>
                        </div>
                    </div>

                    <!-- Список папок и файлов -->
                    <div style="max-height: 400px; overflow-y: auto;">
                        <div id="folderContents">
                            <!-- Содержимое папки будет загружено динамически -->
                        </div>
                    </div>

                    <!-- Статистика найденных файлов -->
                    <div class="mt-3">
                        <div class="alert alert-light">
                            <small>В текущей папке найдено: <strong id="folderLvpCount">0</strong> LVP файлов</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="selectCurrentFolder()">
                        <i class="fas fa-check"></i> Выбрать эту папку
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно массового редактирования -->
    <div class="modal fade" id="batchEditModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="modal-title text-white"><i class="fas fa-edit"></i> Массовое редактирование Email метаданных</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Панель фильтров и действий -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-3 align-items-end">
                                <!-- Фильтры -->
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">Список источник</label>
                                    <select class="form-select form-select-sm" id="batchSourceFile" onchange="loadBatchEditEmails()">
                                        <option value="">Все списки</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">Страна</label>
                                    <select class="form-select form-select-sm" id="batchCountry" onchange="loadBatchEditEmails()">
                                        <option value="">Все страны</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">Категория</label>
                                    <select class="form-select form-select-sm" id="batchCategory" onchange="loadBatchEditEmails()">
                                        <option value="">Все категории</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">Статус</label>
                                    <select class="form-select form-select-sm" id="batchValidationStatus" onchange="loadBatchEditEmails()">
                                        <option value="">Все статусы</option>
                                        <option value="Valid">Valid</option>
                                        <option value="NotSure">NotSure</option>
                                        <option value="Temp">Temp</option>
                                        <option value="Invalid">Invalid</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">Поиск по email</label>
                                    <input type="text" class="form-control form-control-sm" id="batchEmailSearch"
                                           placeholder="email@example.com" onkeyup="debounceFilterBatchEmails()">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-sm btn-danger w-100" onclick="clearBatchFilters()">
                                        <i class="fas fa-times"></i> Сбросить
                                    </button>
                                </div>
                            </div>

                            <!-- Статистика и массовые операции -->
                            <div class="row mt-3 g-3">
                                <div class="col-md-6">
                                    <div class="alert alert-info mb-0 py-2">
                                        <i class="fas fa-info-circle"></i>
                                        Всего записей: <strong id="batchTotalCount">0</strong> |
                                        Выбрано: <strong id="batchSelectedCount">0</strong>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm" id="batchNewStatus" style="max-width: 150px;">
                                            <option value="">Новый статус...</option>
                                            <option value="Valid">Valid</option>
                                            <option value="NotSure">NotSure</option>
                                            <option value="Temp">Temp</option>
                                            <option value="Invalid">Invalid</option>
                                        </select>
                                        <button class="btn btn-sm btn-success" onclick="applyBatchStatusUpdate()">
                                            <i class="fas fa-check-double"></i> Применить к выбранным
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="exportSelectedEmails()">
                                            <i class="fas fa-download"></i> Экспорт выбранных
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Таблица с email -->
                    <div class="table-responsive" style="max-height: calc(100vh - 400px); overflow-y: auto;">
                        <table class="table table-sm table-hover table-striped">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th style="width: 50px;">
                                        <input type="checkbox" class="form-check-input" id="batchSelectAll"
                                               onchange="toggleSelectAllBatch()">
                                    </th>
                                    <th style="width: 50px;">#</th>
                                    <th>Email</th>
                                    <th>Домен</th>
                                    <th>Компания</th>
                                    <th>Список</th>
                                    <th>Страна</th>
                                    <th>Категория</th>
                                    <th>Телефон</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody id="batchEditTableBody">
                                <tr>
                                    <td colspan="10" class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                                        <p class="mt-2">Загрузка данных...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Пагинация -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted small" id="batchPaginationInfo">Страница 1</div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="batchPagination"></ul>
                        </nav>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра результатов -->
    <div class="modal fade" id="resultsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-alt"></i>
                        Результаты обработки: <span id="resultsListName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Навигация по типам файлов -->
                    <ul class="nav nav-tabs mb-3" id="resultsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="clean-tab" data-bs-toggle="tab"
                                    data-bs-target="#clean-pane" type="button">
                                <i class="fas fa-check-circle text-success"></i>
                                Clean <span class="badge bg-success" id="cleanCount">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="blocked-tab" data-bs-toggle="tab"
                                    data-bs-target="#blocked-pane" type="button">
                                <i class="fas fa-ban text-danger"></i>
                                Blocked <span class="badge bg-danger" id="blockedCount">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="metadata-tab" data-bs-toggle="tab"
                                    data-bs-target="#metadata-pane" type="button">
                                <i class="fas fa-database text-info"></i>
                                Metadata <span class="badge bg-info" id="metadataCount">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="report-tab" data-bs-toggle="tab"
                                    data-bs-target="#report-pane" type="button">
                                <i class="fas fa-chart-bar text-primary"></i>
                                HTML Report
                            </button>
                        </li>
                    </ul>

                    <!-- Содержимое вкладок -->
                    <div class="tab-content" id="resultsTabContent">
                        <!-- Clean emails tab -->
                        <div class="tab-pane fade show active" id="clean-pane">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Чистые email адреса</h6>
                                <button class="btn btn-sm btn-primary" onclick="downloadResultFile('clean')">
                                    <i class="fas fa-download"></i> Скачать
                                </button>
                            </div>
                            <div class="preview-container">
                                <pre id="cleanPreview" class="bg-light p-3" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85em;"></pre>
                                <div id="cleanTruncated" class="text-muted text-center mt-2" style="display: none;">
                                    <i class="fas fa-info-circle"></i> Показаны первые 100 строк из <span id="cleanTotal">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Blocked emails tab -->
                        <div class="tab-pane fade" id="blocked-pane">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Заблокированные email</h6>
                                <button class="btn btn-sm btn-primary" onclick="downloadResultFile('blocked')">
                                    <i class="fas fa-download"></i> Скачать
                                </button>
                            </div>
                            <div class="preview-container">
                                <pre id="blockedPreview" class="bg-light p-3" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85em;"></pre>
                                <div id="blockedTruncated" class="text-muted text-center mt-2" style="display: none;">
                                    <i class="fas fa-info-circle"></i> Показаны первые 100 строк из <span id="blockedTotal">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Metadata tab -->
                        <div class="tab-pane fade" id="metadata-pane">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Метаданные (JSON/CSV)</h6>
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="downloadResultFile('metadata-json')" id="downloadMetadataJson">
                                        <i class="fas fa-download"></i> JSON
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="downloadResultFile('metadata-csv')" id="downloadMetadataCsv">
                                        <i class="fas fa-download"></i> CSV
                                    </button>
                                </div>
                            </div>
                            <div class="preview-container">
                                <pre id="metadataPreview" class="bg-light p-3" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.75em;"></pre>
                            </div>
                        </div>

                        <!-- HTML Report tab -->
                        <div class="tab-pane fade" id="report-pane">
                            <div class="text-center py-5">
                                <i class="fas fa-file-pdf fa-3x text-primary mb-3"></i>
                                <h5>HTML отчет с визуальной статистикой</h5>
                                <p class="text-muted">Отчет содержит графики, диаграммы и подробную статистику обработки</p>
                                <button class="btn btn-primary btn-lg mt-3" onclick="openHtmlReport()" id="openReportBtn">
                                    <i class="fas fa-external-link-alt"></i> Открыть отчет в новой вкладке
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно: Панель администратора -->
    <div class="modal fade" id="adminPanel" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-tools"></i> Панель администратора</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Статистика системы -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Статистика системы</h6>
                        </div>
                        <div class="card-body">
                            <div id="adminStatsContent">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Загрузка...</span>
                                    </div>
                                    <p class="mt-2">Загрузка статистики...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Управление кешем -->
                    <div class="card mb-4">
                        <div class="card-header bg-warning">
                            <h6 class="mb-0"><i class="fas fa-database"></i> Управление кешем</h6>
                        </div>
                        <div class="card-body">
                            <p>Кеш содержит хеши обработанных файлов для инкрементальной обработки. Очистка кеша приведет к повторной обработке всех файлов при следующем запуске.</p>
                            <button class="btn btn-warning" onclick="clearCache()">
                                <i class="fas fa-trash-alt"></i> Очистить кеш
                            </button>
                            <div id="clearCacheResult" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- Оптимизация базы данных -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-cog"></i> Оптимизация базы данных</h6>
                        </div>
                        <div class="card-body">
                            <p>Оптимизация базы данных метаданных освобождает неиспользуемое пространство и улучшает производительность. Операция может занять несколько минут для больших баз данных.</p>
                            <button class="btn btn-primary" onclick="optimizeDatabase()">
                                <i class="fas fa-magic"></i> Оптимизировать БД
                            </button>
                            <div id="optimizeDbResult" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- Управление файлами -->
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0"><i class="fas fa-folder-open"></i> Управление файлами</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Файлы input/</h6>
                                    <div id="inputFilesList" style="max-height: 300px; overflow-y: auto;">
                                        <p class="text-muted">Загрузка...</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Файлы output/</h6>
                                    <div id="outputFilesList" style="max-height: 300px; overflow-y: auto;">
                                        <p class="text-muted">Загрузка...</p>
                                    </div>
                                </div>
                            </div>
                            <div id="deleteFileResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-info" onclick="loadAdminStats()">
                        <i class="fas fa-sync-alt"></i> Обновить статистику
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let listsData = [];

        // Загрузка списков при старте страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadLists();
        });

        // Загрузка списков из Python backend
        function loadLists() {
            fetch('/api/lists')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    listsData = data.lists || [];
                    renderLists();
                    updateStats();
                    console.log(`Загружено ${listsData.length} списков`);
                })
                .catch(error => {
                    console.error('Ошибка загрузки списков:', error);

                    // Показываем детальную ошибку
                    const errorMsg = `Ошибка загрузки данных: ${error.message}\n\n` +
                                   `Убедитесь что веб-сервер запущен:\n` +
                                   `python3 web_server.py 8080`;

                    alert(errorMsg);

                    // Загружаем тестовые данные для демонстрации
                    listsData = [
                        {filename: "list1.txt", display_name: "Main Email Database", country: "Mixed", category: "General", priority: 1, processed: true, file_size: 2917244, description: "Primary large email collection"},
                        {filename: "list8.txt", display_name: "New Collection 8", country: "Unknown", category: "General", priority: 8, processed: false, file_size: 673596, description: "Newly added email collection"},
                    ];
                    renderLists();
                    updateStats();
                });
        }

        function renderLists() {
            const tbody = document.getElementById('listsTable');
            tbody.innerHTML = '';

            listsData.forEach((list, index) => {
                const row = document.createElement('tr');

                const statusBadge = list.processed
                    ? '<span class="status-processed"><i class="fas fa-check"></i> Обработан</span>'
                    : '<span class="status-pending"><i class="fas fa-clock"></i> Ожидает</span>';

                // Индикатор метаданных
                const metadataBadge = list.has_metadata
                    ? `<br><span class="badge bg-warning text-dark"><i class="fas fa-database"></i> Метаданные (${list.metadata_files.reduce((sum, f) => sum + f.total_emails, 0)} emails)</span>`
                    : '';

                // Индикатор несоответствий стран
                const mismatchBadge = (list.country_mismatches && list.country_mismatches > 0)
                    ? `<br><span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Несоответствия стран: ${list.country_mismatches}</span>`
                    : '';

                const fileSize = formatFileSize(list.file_size);

                // Кнопка просмотра метаданных доступна только если есть метаданные
                const metadataButton = list.has_metadata
                    ? `<button class="btn btn-sm btn-outline-warning" onclick="showEmailMetadata('${list.filename}')" title="Просмотр email метаданных">
                            <i class="fas fa-envelope-open-text"></i>
                        </button>`
                    : '';

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${list.filename}</strong></td>
                    <td>${list.display_name}</td>
                    <td><span class="badge bg-secondary">${list.country}</span></td>
                    <td><span class="badge bg-info">${list.category}</span></td>
                    <td class="file-size">${fileSize}</td>
                    <td>${statusBadge}${metadataBadge}${mismatchBadge}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick="editList('${list.filename}')" title="Редактировать">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="processOne('${list.filename}')"
                                ${list.processed ? 'disabled' : ''} title="Обработать">
                            <i class="fas fa-play"></i>
                        </button>
                        ${list.processed ? `<button class="btn btn-sm btn-outline-info" onclick="viewResults('${list.filename}')" title="Просмотр результатов">
                            <i class="fas fa-eye"></i>
                        </button>` : ''}
                        ${metadataButton}
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function updateStats() {
            const total = listsData.length;
            const processed = listsData.filter(l => l.processed).length;
            const pending = total - processed;
            const totalSize = listsData.reduce((sum, l) => sum + l.file_size, 0);

            document.getElementById('totalLists').textContent = total;
            document.getElementById('processedLists').textContent = processed;
            document.getElementById('pendingLists').textContent = pending;
            document.getElementById('totalSize').textContent = formatFileSize(totalSize);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
            return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
        }

        function applyFilters() {
            // Применение фильтров - здесь будет логика фильтрации
            renderLists();
        }

        function editList(filename) {
            const list = listsData.find(l => l.filename === filename);
            if (!list) return;

            document.getElementById('editFilename').value = filename;
            document.getElementById('editDisplayName').value = list.display_name;
            document.getElementById('editCountry').value = list.country;
            document.getElementById('editCategory').value = list.category;
            document.getElementById('editPriority').value = list.priority;
            document.getElementById('editDescription').value = list.description || '';

            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        function saveChanges() {
            const filename = document.getElementById('editFilename').value;

            const updatedList = {
                filename: filename,
                display_name: document.getElementById('editDisplayName').value,
                country: document.getElementById('editCountry').value,
                category: document.getElementById('editCategory').value,
                priority: parseInt(document.getElementById('editPriority').value),
                description: document.getElementById('editDescription').value,
                processed: false, // Сохраняем текущий статус
                date_added: new Date().toISOString().split('T')[0]
            };

            fetch('/api/save_list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedList)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadLists(); // Перезагружаем данные
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                } else {
                    alert('Ошибка сохранения: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Ошибка сохранения:', error);
                alert('Ошибка сохранения');
            });
        }

        function processOne(filename) {
            fetch('/api/process_one', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({filename: filename})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showProcessingModal(`Обработка ${filename} запущена...`);
                } else {
                    alert('Ошибка запуска обработки: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Ошибка запуска обработки:', error);
                alert('Ошибка запуска обработки');
            });
        }

        let isProcessing = false; // Флаг для предотвращения повторных запросов

        function runProcessing() {
            // Проверяем, не идет ли уже обработка
            if (isProcessing) {
                alert('Обработка уже запущена! Пожалуйста, дождитесь завершения.');
                return;
            }

            const pending = listsData.filter(l => !l.processed);
            if (pending.length === 0) {
                alert('Все списки уже обработаны!');
                return;
            }

            // Получаем настройки обработки из UI
            const processingMode = document.getElementById('processingMode').value;
            const excludeDuplicates = document.getElementById('excludeDuplicates').checked;
            const generateHtml = document.getElementById('generateHtml').checked;

            // Блокируем кнопку и показываем индикатор загрузки
            isProcessing = true;
            const button = document.querySelector('[onclick="runProcessing()"]');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Запуск...';

            fetch('/api/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    mode: processingMode,
                    exclude_duplicates: excludeDuplicates,
                    generate_html: generateHtml
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showProcessingModal(data.message || 'Обработка всех списков запущена...');
                    // Автоматически обновляем списки через 3 секунды
                    setTimeout(() => {
                        loadLists();
                    }, 3000);
                } else {
                    // Если все списки уже обработаны, показываем сообщение вместо ошибки
                    if (data.message && data.message.includes('уже обработаны')) {
                        alert(data.message);
                        loadLists(); // Обновляем список сразу
                    } else {
                        alert('Ошибка запуска обработки: ' + (data.error || data.message || 'Неизвестная ошибка'));
                    }
                }
            })
            .catch(error => {
                console.error('Ошибка запуска обработки:', error);
                alert('Ошибка запуска обработки');
            })
            .finally(() => {
                // Разблокируем кнопку через 5 секунд
                setTimeout(() => {
                    isProcessing = false;
                    button.disabled = false;
                    button.innerHTML = originalText;
                }, 5000);
            });
        }

        let processingPollInterval = null;

        function showProcessingModal(message) {
            const modal = new bootstrap.Modal(document.getElementById('processingModal'));
            const log = document.getElementById('processingLog');
            const progressBar = document.getElementById('progressBar');
            const closeBtn = document.getElementById('closeProcessing');

            log.innerHTML = message + '\n';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            closeBtn.disabled = true;

            modal.show();

            // Запускаем polling статуса обработки
            if (processingPollInterval) {
                clearInterval(processingPollInterval);
            }

            processingPollInterval = setInterval(() => {
                fetch('/api/processing-status')
                    .then(response => response.json())
                    .then(status => {
                        // Обновляем прогресс
                        const progress = status.progress_percent || 0;
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${progress}%`;

                        // Обновляем лог
                        if (status.logs && status.logs.length > 0) {
                            let logHtml = '';
                            status.logs.forEach(logEntry => {
                                logHtml += `<span class="text-muted">[${logEntry.timestamp}]</span> ${logEntry.message}\n`;
                            });
                            log.innerHTML = logHtml;
                            // Автоскролл к последней строке
                            log.scrollTop = log.scrollHeight;
                        }

                        // Обновляем заголовок с текущим файлом
                        if (status.current_file) {
                            const modalTitle = document.querySelector('#processingModal .modal-title');
                            modalTitle.innerHTML = `<i class="fas fa-cogs"></i> Обработка: ${status.current_file}`;
                        }

                        // Если обработка завершена
                        if (!status.is_running && status.logs && status.logs.length > 0) {
                            clearInterval(processingPollInterval);
                            processingPollInterval = null;
                            closeBtn.disabled = false;

                            // Убираем анимацию прогресс-бара
                            progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');

                            // Обновляем данные через 2 секунды
                            setTimeout(loadLists, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка получения статуса обработки:', error);
                    });
            }, 1000); // Обновление каждую секунду

            // Останавливаем polling при закрытии модального окна
            document.getElementById('processingModal').addEventListener('hidden.bs.modal', function () {
                if (processingPollInterval) {
                    clearInterval(processingPollInterval);
                    processingPollInterval = null;
                }
            });
        }

        function showReport() {
            // Получаем список доступных отчетов
            fetch('/api/reports')
                .then(response => response.json())
                .then(data => {
                    if (data.reports && data.reports.length > 0) {
                        // Открываем последний отчет
                        const latestReport = data.reports[0];
                        window.open(latestReport.path, '_blank');
                    } else {
                        alert('Отчеты не найдены. Сначала запустите обработку списков.');
                    }
                })
                .catch(error => {
                    console.error('Ошибка получения отчетов:', error);
                    alert('Ошибка получения списка отчетов');
                });
        }

        function resetProcessing() {
            // Подтверждение сброса с пользователем
            if (!confirm('Вы уверены, что хотите сбросить все результаты обработки?\n\nЭто удалит:\n- Все файлы из папки output/\n- Кеш обработки\n- Статусы "обработан" во всех списках\n\nЭто действие нельзя отменить!')) {
                return;
            }

            fetch('/api/reset_processing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message || 'Все результаты обработки сброшены');
                    // Автоматически обновляем списки
                    loadLists();
                } else {
                    alert('Ошибка сброса: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Ошибка сброса обработки:', error);
                alert('Ошибка сброса обработки');
            });
        }

        // ===== ФУНКЦИИ УПРАВЛЕНИЯ МЕТАДАННЫМИ =====
        let currentMetadata = {countries: [], categories: []};

        function showMetadataManager() {
            loadMetadataForManager();
            new bootstrap.Modal(document.getElementById('metadataModal')).show();
        }

        function loadMetadataForManager() {
            fetch('/api/metadata')
                .then(response => response.json())
                .then(data => {
                    currentMetadata = data;
                    renderMetadataLists();
                })
                .catch(error => {
                    console.error('Ошибка загрузки метаданных:', error);
                    alert('Ошибка загрузки метаданных');
                });
        }

        function renderMetadataLists() {
            // Рендер списка стран
            const countriesList = document.getElementById('countriesList');
            countriesList.innerHTML = '';
            currentMetadata.countries.forEach(country => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <span>${country}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeMetadata('country', '${country}')"
                            ${['Unknown', 'Mixed', 'Europe'].includes(country) ? 'disabled title="Нельзя удалить базовое значение"' : ''}>
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                countriesList.appendChild(li);
            });

            // Рендер списка категорий
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';
            currentMetadata.categories.forEach(category => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <span>${category}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeMetadata('category', '${category}')"
                            ${category === 'General' ? 'disabled title="Нельзя удалить базовое значение"' : ''}>
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                categoriesList.appendChild(li);
            });
        }

        function addMetadata(type) {
            const inputId = type === 'country' ? 'newCountry' : 'newCategory';
            const value = document.getElementById(inputId).value.trim();

            if (!value) {
                alert('Введите значение');
                return;
            }

            fetch('/api/metadata/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: type,
                    value: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(inputId).value = '';
                    loadMetadataForManager(); // Перезагружаем списки
                } else {
                    alert(data.message || 'Ошибка добавления');
                }
            })
            .catch(error => {
                console.error('Ошибка добавления метаданных:', error);
                alert('Ошибка добавления метаданных');
            });
        }

        function removeMetadata(type, value) {
            if (!confirm(`Удалить "${value}" из списка ${type === 'country' ? 'стран' : 'категорий'}?`)) {
                return;
            }

            fetch('/api/metadata/remove', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: type,
                    value: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadMetadataForManager(); // Перезагружаем списки
                } else {
                    alert(data.message || 'Ошибка удаления');
                }
            })
            .catch(error => {
                console.error('Ошибка удаления метаданных:', error);
                alert('Ошибка удаления метаданных');
            });
        }

        function reloadMetadata() {
            loadMetadataForManager();
            // Также обновляем выпадающие списки в основном интерфейсе
            updateDropdowns();
        }

        // Функция для обновления выпадающих списков в основном интерфейсе
        function updateDropdowns() {
            fetch('/api/metadata')
                .then(response => response.json())
                .then(data => {
                    // Обновляем фильтры
                    updateSelectOptions('filterCountry', data.countries, 'Все страны');
                    updateSelectOptions('filterCategory', data.categories, 'Все категории');

                    // Обновляем селекты в модальном окне редактирования
                    updateSelectOptions('editCountry', data.countries);
                    updateSelectOptions('editCategory', data.categories);
                })
                .catch(error => {
                    console.error('Ошибка обновления выпадающих списков:', error);
                });
        }

        function updateSelectOptions(selectId, options, defaultText = null) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '';

            if (defaultText) {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = defaultText;
                select.appendChild(defaultOption);
            }

            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });

            // Восстанавливаем выбранное значение, если оно есть в новом списке
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Добавляем возможность добавления по Enter
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('newCountry').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMetadata('country');
                }
            });

            document.getElementById('newCategory').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMetadata('category');
                }
            });

            // Загружаем метаданные при запуске для обновления выпадающих списков
            updateDropdowns();
        });

        // Email Metadata Functions
        let currentEmailData = [];
        let filteredEmailData = [];
        let searchDebounceTimer = null;
        let currentSourceFile = null;

        function showEmailMetadata(filename) {
            // Show the metadata section immediately
            const metadataSection = document.getElementById('emailMetadataSection');
            if (metadataSection) {
                metadataSection.style.display = 'block';
            }

            // Очищаем все фильтры кроме source_file
            const emailSearch = document.getElementById('emailSearch');
            if (emailSearch) emailSearch.value = '';

            clearStatusSelection();  // Clear validation status checkboxes

            const countryFilter = document.getElementById('countryFilter');
            if (countryFilter) countryFilter.value = '';

            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) categoryFilter.value = '';

            const phoneFilter = document.getElementById('phoneFilter');
            if (phoneFilter) phoneFilter.value = '';

            // Устанавливаем фильтр по source_file если передан filename
            if (filename) {
                currentSourceFile = filename;
                // Load source files list first, then select the one we need
                loadSourceFilesList().then(() => {
                    // Выбираем нужный файл в dropdown
                    document.getElementById('sourceFileFilter').value = filename;
                    // Загружаем данные для этого файла
                    loadMetadataFromDatabase({source_file: filename});
                });
            } else {
                currentSourceFile = null;
                // Load all metadata
                loadSourceFilesList();
                loadMetadataFromDatabase();
            }

            // Scroll to the metadata section
            document.getElementById('emailMetadataSection').scrollIntoView({ behavior: 'smooth' });
        }

        function loadSourceFilesList() {
            return fetch('/api/lvp-sources')
                .then(response => response.json())
                .then(data => {
                    const sourceFileFilter = document.getElementById('sourceFileFilter');
                    const currentValue = sourceFileFilter.value;

                    sourceFileFilter.innerHTML = '<option value="">Все списки</option>';

                    if (data.sources && data.sources.length > 0) {
                        data.sources.forEach(source => {
                            const option = document.createElement('option');
                            option.value = source.filename;
                            option.textContent = `${source.filename} (${source.total_emails} emails)`;
                            sourceFileFilter.appendChild(option);
                        });
                    }

                    // Restore previous value if it exists
                    if (currentValue) {
                        sourceFileFilter.value = currentValue;
                    }
                })
                .catch(error => {
                    console.error('Error loading source files:', error);
                });
        }

        function debounceSearch() {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                filterEmailsClientSide();
            }, 500); // Wait 500ms after user stops typing
        }

        function loadMetadataFromDatabase(filters = {}) {
            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'inline-block';

            // Build query parameters
            const params = new URLSearchParams();

            if (filters.email) params.append('email', filters.email);
            if (filters.country) params.append('country', filters.country);
            if (filters.category) params.append('category', filters.category);
            if (filters.validation_status) params.append('validation_status', filters.validation_status);
            if (filters.has_phone !== undefined) params.append('has_phone', filters.has_phone);
            if (filters.source_file) params.append('source_file', filters.source_file);

            params.append('limit', filters.limit || 5000);
            params.append('offset', filters.offset || 0);

            fetch(`/api/metadata-search?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    currentEmailData = data.emails || [];
                    filteredEmailData = [...currentEmailData];

                    // Populate country filter from database stats
                    populateFiltersFromDatabase();

                    // Update active filters display
                    updateActiveFiltersDisplay();

                    // Render emails
                    renderEmailMetadata();

                    // Hide loading spinner
                    document.getElementById('loadingSpinner').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error loading metadata from database:', error);
                    alert(`Ошибка загрузки метаданных из базы данных: ${error.message}`);
                    document.getElementById('loadingSpinner').style.display = 'none';
                });
        }

        function populateFiltersFromDatabase() {
            // Сохраняем текущие значения фильтров
            const currentCountry = document.getElementById('countryFilter').value;
            const currentCategory = document.getElementById('categoryFilter').value;

            // Load statistics to populate filters
            fetch('/api/metadata-stats')
                .then(response => response.json())
                .then(stats => {
                    // Populate country filter
                    const countryFilter = document.getElementById('countryFilter');
                    countryFilter.innerHTML = '<option value="">Все страны</option>';

                    Object.keys(stats.countries).forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = `${country} (${stats.countries[country]})`;
                        countryFilter.appendChild(option);
                    });

                    // Восстанавливаем выбранное значение
                    if (currentCountry) {
                        countryFilter.value = currentCountry;
                    }

                    // Populate category filter
                    const categoryFilter = document.getElementById('categoryFilter');
                    categoryFilter.innerHTML = '<option value="">Все категории</option>';

                    Object.keys(stats.categories).forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = `${category} (${stats.categories[category]})`;
                        categoryFilter.appendChild(option);
                    });

                    // Восстанавливаем выбранное значение
                    if (currentCategory) {
                        categoryFilter.value = currentCategory;
                    }
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        function hideEmailMetadata() {
            document.getElementById('emailMetadataSection').style.display = 'none';
            currentEmailData = [];
            filteredEmailData = [];
        }

        function populateCountryFilter() {
            const countryFilter = document.getElementById('countryFilter');
            const countries = [...new Set(currentEmailData.map(email => email.country).filter(Boolean))];

            countryFilter.innerHTML = '<option value="">Все страны</option>';
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        }

        function filterEmails() {
            // Собираем все текущие фильтры из полей формы
            const sourceFileFilter = document.getElementById('sourceFileFilter').value;
            const validationStatuses = getSelectedValidationStatuses();
            const countryFilter = document.getElementById('countryFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const phoneFilter = document.getElementById('phoneFilter').value;
            const countryMismatchFilter = document.getElementById('countryMismatchFilter').value;

            // Build filter object for API (server-side filters)
            const filters = {};

            if (sourceFileFilter) {
                filters.source_file = sourceFileFilter;
            }

            if (validationStatuses.length > 0) {
                filters.validation_status = validationStatuses.join(',');
            }

            if (countryFilter) {
                filters.country = countryFilter;
            }

            if (categoryFilter) {
                filters.category = categoryFilter;
            }

            if (phoneFilter) {
                filters.has_phone = phoneFilter === 'true';
            }

            if (countryMismatchFilter) {
                filters.country_mismatch = countryMismatchFilter === 'true' ? 1 : 0;
            }

            filters.limit = 5000; // Load up to 5000 results

            // Reload data from database with filters
            loadMetadataFromDatabase(filters);
        }

        function filterEmailsClientSide() {
            // Client-side filtering for email search (faster for user experience)
            const searchTerm = document.getElementById('emailSearch').value.trim().toLowerCase();

            if (!searchTerm) {
                filteredEmailData = [...currentEmailData];
            } else {
                filteredEmailData = currentEmailData.filter(email =>
                    email.email.toLowerCase().includes(searchTerm)
                );
            }

            renderEmailMetadata();
        }

        function updateActiveFiltersDisplay() {
            const activeFiltersDiv = document.getElementById('activeFilters');
            if (!activeFiltersDiv) return; // Exit if element not found

            const filters = [];

            const sourceFileFilter = document.getElementById('sourceFileFilter')?.value;
            const validationStatuses = getSelectedValidationStatuses();
            const countryFilter = document.getElementById('countryFilter')?.value;
            const categoryFilter = document.getElementById('categoryFilter')?.value;
            const phoneFilter = document.getElementById('phoneFilter')?.value;
            const emailSearch = document.getElementById('emailSearch')?.value?.trim();

            if (sourceFileFilter) {
                filters.push(`<span class="badge bg-info me-1">Список: ${sourceFileFilter} <i class="fas fa-times" onclick="clearFilter('sourceFileFilter')" style="cursor:pointer"></i></span>`);
            }

            if (validationStatuses && validationStatuses.length > 0) {
                filters.push(`<span class="badge bg-success me-1">Статус: ${validationStatuses.join(', ')} <i class="fas fa-times" onclick="clearStatusSelection()" style="cursor:pointer"></i></span>`);
            }

            if (countryFilter) {
                filters.push(`<span class="badge bg-warning me-1">Страна: ${countryFilter} <i class="fas fa-times" onclick="clearFilter('countryFilter')" style="cursor:pointer"></i></span>`);
            }

            if (categoryFilter) {
                filters.push(`<span class="badge bg-primary me-1">Категория: ${categoryFilter} <i class="fas fa-times" onclick="clearFilter('categoryFilter')" style="cursor:pointer"></i></span>`);
            }

            if (phoneFilter) {
                const phoneText = phoneFilter === 'true' ? 'С телефоном' : 'Без телефона';
                filters.push(`<span class="badge bg-secondary me-1">${phoneText} <i class="fas fa-times" onclick="clearFilter('phoneFilter')" style="cursor:pointer"></i></span>`);
            }

            if (emailSearch) {
                filters.push(`<span class="badge bg-dark me-1">Email: ${emailSearch} <i class="fas fa-times" onclick="clearFilter('emailSearch')" style="cursor:pointer"></i></span>`);
            }

            if (filters.length > 0) {
                activeFiltersDiv.innerHTML = `<div class="small">Активные фильтры: ${filters.join('')}</div>`;
            } else {
                activeFiltersDiv.innerHTML = '';
            }
        }

        function clearFilter(filterId) {
            document.getElementById(filterId).value = '';
            if (filterId === 'emailSearch') {
                filterEmailsClientSide();
                updateActiveFiltersDisplay();
            } else {
                filterEmails();
            }
        }

        function renderEmailMetadata() {
            const tbody = document.getElementById('emailMetadataTable');
            const emailCount = document.getElementById('emailCount');

            tbody.innerHTML = '';
            emailCount.textContent = `${filteredEmailData.length} emails`;

            // Update active filters display
            updateActiveFiltersDisplay();

            filteredEmailData.forEach((email, index) => {
                const row = document.createElement('tr');

                const statusBadge = email.validation_status === 'Valid'
                    ? '<span class="badge bg-success">Valid</span>'
                    : email.validation_status === 'NotSure'
                    ? '<span class="badge bg-warning">NotSure</span>'
                    : email.validation_status === 'Temp'
                    ? '<span class="badge bg-info">Temp</span>'
                    : email.validation_status === 'Invalid'
                    ? '<span class="badge bg-danger">Invalid</span>'
                    : '<span class="badge bg-secondary">Unknown</span>';

                const phoneDisplay = email.phone || '-';
                const companyDisplay = email.company_name || '-';
                const countryDisplay = email.country || '-';
                const categoryDisplay = email.category || '-';

                // Country mismatch indicator
                let countryMismatchBadge = '';
                if (email.country_mismatch && email.country_mismatch === 1) {
                    const listCountry = email.list_country || 'N/A';
                    countryMismatchBadge = `<br><span class="badge bg-danger" title="Email страна: ${countryDisplay}, Список страна: ${listCountry}">
                        <i class="fas fa-exclamation-triangle"></i> Несоответствие
                    </span>`;
                }

                // Format source_file display (extract filename without extension)
                let sourceFileDisplay = '-';
                if (email.source_file) {
                    const fileName = email.source_file.replace(/\.(lvp|json|csv|txt)$/i, '');
                    // Truncate long filenames
                    sourceFileDisplay = fileName.length > 30
                        ? `<span title="${email.source_file}">${fileName.substring(0, 27)}...</span>`
                        : `<span title="${email.source_file}">${fileName}</span>`;
                }

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="text-break">
                        <span class="fw-bold">${email.email}</span>
                    </td>
                    <td class="text-break small">${email.domain || '-'}</td>
                    <td class="text-break small">${companyDisplay}</td>
                    <td class="text-break small text-muted">${sourceFileDisplay}</td>
                    <td class="small">${countryDisplay}${countryMismatchBadge}</td>
                    <td class="text-break small">${phoneDisplay}</td>
                    <td class="small">${categoryDisplay}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showEmailDetails(${index})" title="Детали">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        ${email.source_url ? `<a href="${email.source_url}" target="_blank" class="btn btn-sm btn-primary" title="Открыть источник">
                            <i class="fas fa-external-link-alt"></i>
                        </a>` : ''}
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function showEmailDetails(index) {
            const email = filteredEmailData[index];

            // Populate email details modal
            document.getElementById('detailEmail').textContent = email.email;
            document.getElementById('detailDomain').textContent = email.domain || '-';
            document.getElementById('detailValidationStatus').innerHTML = email.validation_status === 'Valid'
                ? '<span class="badge bg-success">Valid</span>'
                : email.validation_status === 'NotSure'
                ? '<span class="badge bg-warning">NotSure</span>'
                : email.validation_status === 'Temp'
                ? '<span class="badge bg-info">Temp</span>'
                : email.validation_status === 'Invalid'
                ? '<span class="badge bg-danger">Invalid</span>'
                : '<span class="badge bg-secondary">Unknown</span>';
            document.getElementById('detailValidationDate').textContent = email.validation_date || '-';

            document.getElementById('detailCompanyName').textContent = email.company_name || '-';
            document.getElementById('detailPhone').textContent = email.phone || '-';
            document.getElementById('detailCountry').textContent = email.country || '-';
            document.getElementById('detailCity').textContent = email.city || '-';
            document.getElementById('detailAddress').textContent = email.address || '-';
            document.getElementById('detailCategory').textContent = email.category || '-';

            document.getElementById('detailSourceUrl').innerHTML = email.source_url
                ? `<a href="${email.source_url}" target="_blank">${email.source_url}</a>`
                : '-';
            document.getElementById('detailPageTitle').textContent = email.page_title || '-';
            document.getElementById('detailKeywords').textContent = email.keywords || '-';
            document.getElementById('detailMetaDescription').textContent = email.meta_description || '-';
            document.getElementById('detailMetaKeywords').textContent = email.meta_keywords || '-';

            document.getElementById('detailValidationLog').textContent = email.validation_log || 'No validation log available';

            // Show modal
            new bootstrap.Modal(document.getElementById('emailDetailsModal')).show();
        }

        // ===== ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ ФИЛЬТРАЦИИ =====

        function clearAllFilters() {
            // Clear all filters
            document.getElementById('emailSearch').value = '';
            document.getElementById('sourceFileFilter').value = '';
            clearStatusSelection();  // Clear validation status checkboxes
            document.getElementById('countryFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('phoneFilter').value = '';

            // Clear advanced filters
            document.getElementById('advancedEmailPattern').value = '';
            document.getElementById('advancedDomain').value = '';
            document.getElementById('advancedCompany').value = '';
            document.getElementById('advancedCity').value = '';
            document.getElementById('advancedValidationStatus').value = '';
            document.getElementById('advancedPhoneFilter').value = '';
            document.getElementById('advancedLimit').value = '1000';
            document.getElementById('advancedSourceFile').value = '';

            // Reload unfiltered data
            loadMetadataFromDatabase();
        }

        function exportFilteredResults() {
            if (filteredEmailData.length === 0) {
                alert('Нет данных для экспорта. Сначала загрузите метаданные.');
                return;
            }

            // Show export options
            const format = prompt('Выберите формат экспорта:\n1 - CSV\n2 - JSON\n\nВведите 1 или 2:', '1');

            if (format === '1') {
                exportToCSV();
            } else if (format === '2') {
                exportToJSON();
            } else if (format !== null) {
                alert('Неверный формат. Выберите 1 (CSV) или 2 (JSON).');
            }
        }

        function exportToCSV() {
            const headers = [
                'Email', 'Domain', 'Company', 'Country', 'City', 'Phone',
                'Category', 'Validation Status', 'Source URL', 'Page Title'
            ];

            const csvData = [headers.join(',')];

            filteredEmailData.forEach(email => {
                const row = [
                    email.email || '',
                    email.domain || '',
                    email.company_name || '',
                    email.country || '',
                    email.city || '',
                    email.phone || '',
                    email.category || '',
                    email.validation_status || '',
                    email.source_url || '',
                    email.page_title || ''
                ].map(field => `"${String(field).replace(/"/g, '""')}"`);

                csvData.push(row.join(','));
            });

            downloadFile(csvData.join('\n'), `email_metadata_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function exportToJSON() {
            const jsonData = JSON.stringify(filteredEmailData, null, 2);
            downloadFile(jsonData, `email_metadata_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function showAdvancedFilters() {
            new bootstrap.Modal(document.getElementById('advancedFiltersModal')).show();
        }

        function applyAdvancedFilters() {
            const filters = {};

            // Get advanced filter values
            const emailPattern = document.getElementById('advancedEmailPattern').value.trim();
            const domain = document.getElementById('advancedDomain').value.trim();
            const company = document.getElementById('advancedCompany').value.trim();
            const city = document.getElementById('advancedCity').value.trim();
            const validationStatus = document.getElementById('advancedValidationStatus').value;
            const phoneFilter = document.getElementById('advancedPhoneFilter').value;
            const limit = document.getElementById('advancedLimit').value;
            const sourceFile = document.getElementById('advancedSourceFile').value.trim();

            // Build filter object
            if (emailPattern) filters.email = emailPattern;
            if (domain) filters.domain = domain;
            if (company) filters.company_name = company;
            if (city) filters.city = city;
            if (validationStatus) filters.validation_status = validationStatus;
            if (phoneFilter) filters.has_phone = phoneFilter === 'true';
            if (sourceFile) filters.source_file = sourceFile;

            filters.limit = parseInt(limit) || 1000;

            // Also include basic filters
            const basicEmailSearch = document.getElementById('emailSearch').value.trim();
            const basicCountry = document.getElementById('countryFilter').value;
            const basicCategory = document.getElementById('categoryFilter').value;

            if (basicEmailSearch && !emailPattern) filters.email = basicEmailSearch;
            if (basicCountry) filters.country = basicCountry;
            if (basicCategory) filters.category = basicCategory;

            // Apply filters
            loadMetadataFromDatabase(filters);

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('advancedFiltersModal')).hide();
        }

        function clearAdvancedFilters() {
            document.getElementById('advancedEmailPattern').value = '';
            document.getElementById('advancedDomain').value = '';
            document.getElementById('advancedCompany').value = '';
            document.getElementById('advancedCity').value = '';
            document.getElementById('advancedValidationStatus').value = '';
            document.getElementById('advancedPhoneFilter').value = '';
            document.getElementById('advancedLimit').value = '1000';
            document.getElementById('advancedSourceFile').value = '';
        }

        // ===== ФУНКЦИИ ЗАГРУЗКИ ФАЙЛОВ =====

        // Drag and drop setup
        const uploadZone = document.getElementById('uploadZone');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.remove('dragover');

            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        function handleFileSelect(event) {
            const files = event.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;

            // Reset UI
            document.getElementById('uploadResults').innerHTML = '';
            document.getElementById('uploadResults').style.display = 'none';

            // Validate files
            const validFiles = [];
            const errors = [];

            for (let file of files) {
                // Check file extension
                const ext = file.name.toLowerCase().split('.').pop();
                if (ext !== 'txt' && ext !== 'lvp') {
                    errors.push(`${file.name}: неподдерживаемый формат (только .txt или .lvp)`);
                    continue;
                }

                // Check file size
                if (file.size > 100 * 1024 * 1024) {
                    errors.push(`${file.name}: файл слишком большой (макс. 100MB)`);
                    continue;
                }

                if (file.size === 0) {
                    errors.push(`${file.name}: файл пустой`);
                    continue;
                }

                validFiles.push(file);
            }

            // Show errors if any
            if (errors.length > 0) {
                showUploadErrors(errors);
            }

            // Upload valid files
            if (validFiles.length > 0) {
                uploadFiles(validFiles);
            }
        }

        function showUploadErrors(errors) {
            const resultsDiv = document.getElementById('uploadResults');
            resultsDiv.style.display = 'block';

            errors.forEach(error => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'upload-result-item error';
                errorDiv.innerHTML = `
                    <span><i class="fas fa-times-circle"></i> ${error}</span>
                `;
                resultsDiv.appendChild(errorDiv);
            });
        }

        async function uploadFiles(files) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('uploadProgressBar');
            const statusText = document.getElementById('uploadStatus');
            const resultsDiv = document.getElementById('uploadResults');

            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '';

            let completed = 0;
            const total = files.length;

            for (let file of files) {
                statusText.textContent = `Загрузка ${file.name}...`;

                try {
                    const result = await uploadSingleFile(file);

                    completed++;
                    const progress = Math.round((completed / total) * 100);
                    progressBar.style.width = `${progress}%`;

                    // Show success
                    const successDiv = document.createElement('div');
                    successDiv.className = 'upload-result-item success';
                    successDiv.innerHTML = `
                        <span><i class="fas fa-check-circle"></i> ${file.name} загружен успешно</span>
                        <span class="text-muted">${formatFileSize(file.size)}</span>
                    `;
                    resultsDiv.appendChild(successDiv);

                } catch (error) {
                    completed++;
                    const progress = Math.round((completed / total) * 100);
                    progressBar.style.width = `${progress}%`;

                    // Show error
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'upload-result-item error';
                    errorDiv.innerHTML = `
                        <span><i class="fas fa-times-circle"></i> ${file.name}: ${error.message}</span>
                    `;
                    resultsDiv.appendChild(errorDiv);
                }
            }

            // Upload complete
            statusText.textContent = `Загружено ${completed} из ${total} файлов`;

            // Reload lists to show new files
            setTimeout(() => {
                loadLists();
                progressDiv.style.display = 'none';
            }, 2000);
        }

        function uploadSingleFile(file) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);

                fetch('/api/upload-file', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `HTTP ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        resolve(data);
                    } else {
                        reject(new Error(data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    reject(error);
                });
            });
        }

        // ===== ФУНКЦИИ УПРАВЛЕНИЯ ОБОГАЩЕНИЕМ =====

        let enrichmentData = null;

        function showEnrichmentManager() {
            loadEnrichmentData();
            new bootstrap.Modal(document.getElementById('enrichmentModal')).show();
        }

        function loadEnrichmentData() {
            fetch('/api/enrichment-suggestions')
                .then(response => response.json())
                .then(data => {
                    enrichmentData = data;
                    renderEnrichmentData();
                })
                .catch(error => {
                    console.error('Ошибка загрузки данных обогащения:', error);
                    alert('Ошибка загрузки данных обогащения');
                });
        }

        function renderEnrichmentData() {
            if (!enrichmentData) return;

            // Обновляем статистику
            document.getElementById('enrichmentPendingFiles').textContent = enrichmentData.summary.pending_files;
            document.getElementById('enrichmentPendingEmails').textContent = enrichmentData.summary.pending_emails.toLocaleString();

            // Рендерим список файлов для обогащения
            const pendingList = document.getElementById('enrichmentFilesList');
            pendingList.innerHTML = '';

            if (enrichmentData.pending_enrichment.length === 0) {
                pendingList.innerHTML = '<p class="text-muted">Все списки уже обогащены!</p>';
            } else {
                enrichmentData.pending_enrichment.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'card mb-2';

                    const sizeDisplay = formatFileSize(file.size);
                    const dateDisplay = new Date(file.modified).toLocaleString('ru-RU');

                    fileDiv.innerHTML = `
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">${file.filename}</h6>
                                    <small class="text-muted">${file.email_count} emails • ${sizeDisplay} • ${dateDisplay}</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="enrichSingleList('${file.path}', '${file.filename}')">
                                        <i class="fas fa-plus"></i> Обогатить
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    pendingList.appendChild(fileDiv);
                });
            }

            // Рендерим список обогащенных файлов
            const enrichedList = document.getElementById('enrichedFilesList');
            enrichedList.innerHTML = '';

            if (enrichmentData.already_enriched.length === 0) {
                enrichedList.innerHTML = '<p class="text-muted">Обогащенных списков пока нет</p>';
            } else {
                enrichmentData.already_enriched.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'card mb-2 bg-light';

                    const sizeDisplay = formatFileSize(file.size);

                    fileDiv.innerHTML = `
                        <div class="card-body py-2">
                            <h6 class="card-title mb-1 text-success">
                                <i class="fas fa-check-circle"></i> ${file.filename}
                            </h6>
                            <small class="text-muted">${file.email_count} emails • ${sizeDisplay}</small>
                        </div>
                    `;

                    enrichedList.appendChild(fileDiv);
                });
            }
        }

        function enrichSingleList(filePath, filename) {
            showEnrichmentProgress();

            updateEnrichmentLog(`🔄 Начинаем обогащение: ${filename}`);

            fetch('/api/enrich-list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: filePath,
                    force_overwrite: false
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const result = data.result;
                    updateEnrichmentLog(`✅ ${filename} обогащен успешно!`);
                    updateEnrichmentLog(`📊 Найдено метаданных: ${result.enriched_count}/${result.total_emails} (${result.enrichment_ratio.toFixed(1)}%)`);
                    updateEnrichmentLog(`💾 Сохранено: ${result.output_csv}, ${result.output_json}`);

                    // Обновляем прогресс бар
                    updateEnrichmentProgress(100);

                    // Перезагружаем данные
                    setTimeout(() => {
                        hideEnrichmentProgress();
                        loadEnrichmentData();
                    }, 2000);
                } else {
                    updateEnrichmentLog(`❌ Ошибка: ${data.error}`);
                    setTimeout(hideEnrichmentProgress, 3000);
                }
            })
            .catch(error => {
                console.error('Ошибка обогащения:', error);
                updateEnrichmentLog(`❌ Ошибка обогащения: ${error.message}`);
                setTimeout(hideEnrichmentProgress, 3000);
            });
        }

        function enrichAllLists(forceOverwrite = false) {
            if (!enrichmentData || enrichmentData.pending_enrichment.length === 0) {
                alert('Нет списков для обогащения');
                return;
            }

            const action = forceOverwrite ? 'переобогатить' : 'обогатить';
            if (!confirm(`Вы уверены, что хотите ${action} все доступные списки?\n\nБудет обработано ${enrichmentData.summary.pending_files} файлов с ${enrichmentData.summary.pending_emails.toLocaleString()} email.`)) {
                return;
            }

            showEnrichmentProgress();
            updateEnrichmentLog(`🚀 Начинаем массовое обогащение ${enrichmentData.summary.pending_files} файлов...`);

            fetch('/api/enrich-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    force_overwrite: forceOverwrite
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    updateEnrichmentLog(`🎉 Массовое обогащение завершено!`);
                    updateEnrichmentLog(`📊 Обработано файлов: ${stats.files_processed}`);
                    updateEnrichmentLog(`📧 Всего email: ${stats.total_emails.toLocaleString()}`);
                    updateEnrichmentLog(`✅ Обогащено: ${stats.enriched_emails.toLocaleString()}`);
                    updateEnrichmentLog(`❌ Не найдено: ${stats.not_found_emails.toLocaleString()}`);

                    // Обновляем прогресс бар
                    updateEnrichmentProgress(100);

                    // Перезагружаем данные
                    setTimeout(() => {
                        hideEnrichmentProgress();
                        loadEnrichmentData();
                    }, 3000);
                } else {
                    updateEnrichmentLog(`❌ Ошибка: ${data.error}`);
                    setTimeout(hideEnrichmentProgress, 3000);
                }
            })
            .catch(error => {
                console.error('Ошибка массового обогащения:', error);
                updateEnrichmentLog(`❌ Ошибка массового обогащения: ${error.message}`);
                setTimeout(hideEnrichmentProgress, 3000);
            });
        }

        function showEnrichmentProgress() {
            document.getElementById('enrichmentProgress').style.display = 'block';
            document.getElementById('enrichmentLog').innerHTML = '';
            updateEnrichmentProgress(0);
        }

        function hideEnrichmentProgress() {
            document.getElementById('enrichmentProgress').style.display = 'none';
        }

        function updateEnrichmentProgress(percent) {
            const progressBar = document.getElementById('enrichmentProgressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        }

        function updateEnrichmentLog(message) {
            const log = document.getElementById('enrichmentLog');
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function refreshEnrichmentData() {
            loadEnrichmentData();
        }

        // ===== ФУНКЦИИ УПРАВЛЕНИЯ ИМПОРТОМ LVP =====

        let lvpData = null;

        function showLVPImportManager() {
            loadLVPData();
            new bootstrap.Modal(document.getElementById('lvpImportModal')).show();
        }

        function loadLVPData() {
            const customPath = document.getElementById('lvpFolderPath').value.trim();

            // Используем кастомный путь если он указан, иначе API по умолчанию
            if (customPath && customPath !== '/mnt/e/shtim/Downloads/') {
                loadCustomLVPFolder(customPath);
            } else {
                fetch('/api/lvp-scan')
                    .then(response => response.json())
                    .then(data => {
                        lvpData = data;
                        renderLVPData();
                    })
                    .catch(error => {
                        console.error('Ошибка загрузки LVP данных:', error);
                        alert('Ошибка загрузки данных LVP файлов');
                    });
            }
        }

        function loadCustomLVPFolder(folderPath) {
            fetch(`/api/lvp-browse-folder?path=${encodeURIComponent(folderPath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Преобразуем данные в формат, совместимый с renderLVPData
                    lvpData = {
                        available_files: data.lvp_files,
                        imported_sources: [],
                        total_files: data.total_files,
                        new_files: data.total_files,
                        imported_files: 0
                    };
                    renderLVPData();
                })
                .catch(error => {
                    console.error('Ошибка загрузки папки:', error);
                    alert(`Ошибка загрузки папки: ${error.message}`);
                });
        }

        function renderLVPData() {
            if (!lvpData) return;

            // Обновляем статистику
            document.getElementById('lvpTotalFiles').textContent = lvpData.total_files;
            document.getElementById('lvpNewFiles').textContent = lvpData.new_files;
            document.getElementById('lvpImportedFiles').textContent = lvpData.imported_files;

            // Рендерим список доступных файлов
            const availableList = document.getElementById('lvpFilesList');
            availableList.innerHTML = '';

            if (lvpData.available_files.length === 0) {
                availableList.innerHTML = '<p class="text-muted">Все LVP файлы уже импортированы!</p>';
            } else {
                lvpData.available_files.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'card mb-2';

                    const sizeDisplay = formatFileSize(file.file_size);
                    const dateDisplay = new Date(file.modified_date).toLocaleString('ru-RU');

                    fileDiv.innerHTML = `
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">${file.filename}</h6>
                                    <small class="text-muted">${sizeDisplay} • ${dateDisplay}</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="importSingleLVP('${file.file_path}', '${file.filename}')">
                                        <i class="fas fa-download"></i> Импорт
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    availableList.appendChild(fileDiv);
                });
            }

            // Рендерим список импортированных файлов
            const importedList = document.getElementById('lvpImportedList');
            importedList.innerHTML = '';

            if (lvpData.imported_sources.length === 0) {
                importedList.innerHTML = '<p class="text-muted">Пока нет импортированных файлов</p>';
            } else {
                lvpData.imported_sources.forEach(source => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'card mb-2 bg-light';

                    const sizeDisplay = formatFileSize(source.file_size);
                    const dateDisplay = new Date(source.import_date).toLocaleString('ru-RU');

                    fileDiv.innerHTML = `
                        <div class="card-body py-2">
                            <h6 class="card-title mb-1 text-success">
                                <i class="fas fa-check-circle"></i> ${source.filename}
                            </h6>
                            <small class="text-muted">
                                ${source.total_emails} emails (${source.valid_emails} валидных)
                                <br>${sizeDisplay} • Импортирован: ${dateDisplay}
                            </small>
                        </div>
                    `;

                    importedList.appendChild(fileDiv);
                });
            }
        }

        function importSingleLVP(filePath, filename) {
            showLVPProgress();
            updateLVPLog(`🔄 Начинаем импорт: ${filename}`);

            fetch('/api/import-lvp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'import_single',
                    file_path: filePath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateLVPLog(`✅ ${filename} импортирован успешно!`);
                    updateLVPLog(`📊 Импортировано email: ${data.stats.imported_emails}`);
                    updateLVPLog(`✅ Валидных: ${data.stats.valid_emails}`);
                    updateLVPLog(`❌ Невалидных: ${data.stats.invalid_emails}`);

                    // Обновляем прогресс бар
                    updateLVPProgress(100);

                    // Перезагружаем данные
                    setTimeout(() => {
                        hideLVPProgress();
                        loadLVPData();
                    }, 2000);
                } else {
                    updateLVPLog(`❌ Ошибка: ${data.error}`);
                    setTimeout(hideLVPProgress, 3000);
                }
            })
            .catch(error => {
                console.error('Ошибка импорта:', error);
                updateLVPLog(`❌ Ошибка импорта: ${error.message}`);
                setTimeout(hideLVPProgress, 3000);
            });
        }

        function importAllLVP() {
            if (!lvpData || lvpData.new_files === 0) {
                alert('Нет новых файлов для импорта');
                return;
            }

            if (!confirm(`Вы уверены, что хотите импортировать все ${lvpData.new_files} новых LVP файлов?\n\nЭто может занять некоторое время.`)) {
                return;
            }

            showLVPProgress();
            updateLVPLog(`🚀 Начинаем импорт ${lvpData.new_files} LVP файлов...`);

            fetch('/api/import-lvp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'import_all'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success || data.files_processed > 0) {
                    const stats = data.overall_stats;
                    updateLVPLog(`🎉 Импорт завершен!`);
                    updateLVPLog(`📊 Обработано файлов: ${stats.files_processed}`);
                    updateLVPLog(`📧 Импортировано email: ${stats.emails_imported}`);
                    updateLVPLog(`⏭️ Пропущено email: ${stats.emails_skipped}`);
                    if (stats.errors && stats.errors.length > 0) {
                        updateLVPLog(`⚠️ Ошибки: ${stats.errors.length}`);
                    }

                    updateLVPProgress(100);

                    setTimeout(() => {
                        hideLVPProgress();
                        loadLVPData();
                    }, 3000);
                } else {
                    updateLVPLog(`❌ ${data.message || 'Ошибка импорта'}`);
                    setTimeout(hideLVPProgress, 3000);
                }
            })
            .catch(error => {
                console.error('Ошибка массового импорта:', error);
                updateLVPLog(`❌ Ошибка массового импорта: ${error.message}`);
                setTimeout(hideLVPProgress, 3000);
            });
        }

        function scanLVPFolder() {
            loadLVPData();
        }

        function showLVPProgress() {
            document.getElementById('lvpImportProgress').style.display = 'block';
            document.getElementById('lvpImportLog').innerHTML = '';
            updateLVPProgress(0);
        }

        function hideLVPProgress() {
            document.getElementById('lvpImportProgress').style.display = 'none';
        }

        function updateLVPProgress(percent) {
            const progressBar = document.getElementById('lvpProgressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        }

        function updateLVPLog(message) {
            const log = document.getElementById('lvpImportLog');
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function showLVPHelp() {
            alert(`📚 Справка по импорту LVP файлов:

1. LVP файлы содержат метаданные email адресов:
   - Источник (URL)
   - Название компании
   - Телефон, адрес, страна
   - Категория бизнеса
   - Статус валидации

2. Файлы автоматически сканируются из:
   /mnt/e/shtim/Downloads/

3. Система автоматически:
   - Проверяет дубликаты по хешу файла
   - Обновляет существующие записи
   - Добавляет новые метаданные

4. После импорта метаданные можно использовать:
   - Для фильтрации списков
   - Для обогащения email данными
   - Для создания отчетов`);
        }

        // ===== ФУНКЦИИ ОБЗОРА ПАПОК =====

        let currentBrowsePath = '/mnt/e/shtim/Downloads/';

        function browseLVPFolder() {
            // Используем текущий путь из поля или путь по умолчанию
            const currentPath = document.getElementById('lvpFolderPath').value.trim();
            currentBrowsePath = currentPath || '/mnt/e/shtim/Downloads/';

            // Инициализируем поле пути в модальном окне
            document.getElementById('currentFolderPath').value = currentBrowsePath;

            // Загружаем содержимое папки
            loadFolderContents(currentBrowsePath)
                .catch(error => {
                    console.error('Ошибка загрузки начальной папки:', error);
                    alert(`Не удалось загрузить папку "${currentBrowsePath}".\n\nОшибка: ${error.message}`);
                });

            // Показываем модальное окно
            new bootstrap.Modal(document.getElementById('folderBrowseModal')).show();
        }

        function loadFolderContents(folderPath) {
            return fetch(`/api/lvp-browse-folder?path=${encodeURIComponent(folderPath)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    currentBrowsePath = data.current_folder;
                    document.getElementById('currentFolderPath').value = currentBrowsePath;
                    document.getElementById('folderLvpCount').textContent = data.total_files;

                    // Отключаем кнопку "Вверх" если мы в корне
                    document.getElementById('parentButton').disabled = !data.parent_folder;

                    renderFolderContents(data);
                    return data; // Возвращаем данные для использования в цепочке Promise
                });
        }

        function renderFolderContents(data) {
            const container = document.getElementById('folderContents');
            container.innerHTML = '';

            // Добавляем подпапки
            data.subdirs.forEach(subdir => {
                const dirDiv = document.createElement('div');
                dirDiv.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                dirDiv.style.cursor = 'pointer';
                dirDiv.onclick = () => {
                    loadFolderContents(subdir.path)
                        .catch(error => {
                            console.error('Ошибка навигации в подпапку:', error);
                            alert(`Не удалось открыть папку "${subdir.name}".\n\nОшибка: ${error.message}`);
                        });
                };

                dirDiv.innerHTML = `
                    <div>
                        <i class="fas fa-folder text-warning me-2"></i>
                        <strong>${subdir.name}</strong>
                    </div>
                    <i class="fas fa-chevron-right text-muted"></i>
                `;

                container.appendChild(dirDiv);
            });

            // Добавляем LVP файлы (только для отображения)
            data.lvp_files.forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'list-group-item d-flex justify-content-between align-items-center';

                const sizeDisplay = formatFileSize(file.file_size);
                const dateDisplay = new Date(file.modified_date).toLocaleString('ru-RU');

                fileDiv.innerHTML = `
                    <div>
                        <i class="fas fa-file-archive text-info me-2"></i>
                        ${file.filename}
                        <br>
                        <small class="text-muted">${sizeDisplay} • ${dateDisplay}</small>
                    </div>
                    <span class="badge bg-primary">LVP</span>
                `;

                container.appendChild(fileDiv);
            });

            if (data.subdirs.length === 0 && data.lvp_files.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">Папка пуста</div>';
            }
        }

        function navigateToParent() {
            const parentPath = currentBrowsePath.split('/').slice(0, -1).join('/') || '/';

            loadFolderContents(parentPath)
                .catch(error => {
                    console.error('Ошибка навигации в родительскую папку:', error);
                    alert(`Не удалось перейти в родительскую папку.\n\nОшибка: ${error.message}`);
                });
        }

        function selectCurrentFolder() {
            document.getElementById('lvpFolderPath').value = currentBrowsePath;
            bootstrap.Modal.getInstance(document.getElementById('folderBrowseModal')).hide();

            // Автоматически обновляем список после выбора папки
            loadLVPData();
        }

        function loadCustomPath() {
            const pathInput = document.getElementById('currentFolderPath');
            const loadButton = document.getElementById('loadButton');
            const manualPath = pathInput.value.trim();

            // Валидация пути
            const validationResult = validateFolderPath(manualPath);
            if (!validationResult.valid) {
                alert(validationResult.message);
                pathInput.focus();
                return;
            }

            // Показываем индикатор загрузки
            const originalButtonText = loadButton.innerHTML;
            loadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
            loadButton.disabled = true;
            pathInput.disabled = true;

            // Нормализуем путь
            const normalizedPath = normalizePath(manualPath);

            // Загружаем содержимое папки
            currentBrowsePath = normalizedPath;

            loadFolderContents(currentBrowsePath)
                .then(() => {
                    // Успешная загрузка - обновляем интерфейс
                    pathInput.value = currentBrowsePath;
                })
                .catch(error => {
                    // Ошибка загрузки - показываем детальное сообщение
                    console.error('Ошибка загрузки пути:', error);
                    alert(`Не удалось открыть папку "${normalizedPath}".\n\nВозможные причины:\n• Папка не существует\n• Нет прав доступа\n• Неверный формат пути\n\nПроверьте путь и попробуйте снова.`);
                })
                .finally(() => {
                    // Восстанавливаем состояние кнопки и поля
                    loadButton.innerHTML = originalButtonText;
                    loadButton.disabled = false;
                    pathInput.disabled = false;
                });
        }

        function validateFolderPath(path) {
            if (!path) {
                return { valid: false, message: 'Пожалуйста, введите путь к папке' };
            }

            if (!path.startsWith('/')) {
                return { valid: false, message: 'Путь должен быть абсолютным (начинаться с /)' };
            }

            if (path.length > 4096) {
                return { valid: false, message: 'Путь слишком длинный (максимум 4096 символов)' };
            }

            // Проверка на недопустимые символы
            const invalidChars = /[<>"|?*\x00-\x1f]/;
            if (invalidChars.test(path)) {
                return { valid: false, message: 'Путь содержит недопустимые символы' };
            }

            // Проверка на правильный формат Unix пути
            if (!/^\/(?:[^\/\0]+\/)*[^\/\0]*$/.test(path)) {
                return { valid: false, message: 'Неверный формат пути. Используйте Unix формат: /path/to/folder' };
            }

            return { valid: true };
        }

        function normalizePath(path) {
            // Убираем лишние слеши и нормализуем путь
            return path.replace(/\/+/g, '/').replace(/\/$/, '') || '/';
        }

        function handlePathKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loadCustomPath();
            }
        }

        // ===== МАССОВОЕ РЕДАКТИРОВАНИЕ EMAIL МЕТАДАННЫХ =====

        let batchEditData = [];
        let batchFilteredData = [];
        let batchSelectedEmails = new Set();
        let batchDebounceTimer = null;
        let batchCurrentPage = 1;
        let batchItemsPerPage = 100;

        function showBatchEditModal() {
            // Загружаем справочники для фильтров
            loadBatchEditDropdowns();
            // Загружаем данные
            loadBatchEditEmails();
            // Показываем модальное окно
            new bootstrap.Modal(document.getElementById('batchEditModal')).show();
        }

        function loadBatchEditDropdowns() {
            // Загружаем источники (LVP списки)
            fetch('/api/lvp-sources')
                .then(response => response.json())
                .then(data => {
                    const sourceSelect = document.getElementById('batchSourceFile');
                    sourceSelect.innerHTML = '<option value="">Все списки</option>';
                    data.sources.forEach(source => {
                        const option = document.createElement('option');
                        option.value = source.filename;
                        option.textContent = `${source.filename} (${source.total_emails} emails)`;
                        sourceSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading sources:', error));

            // Загружаем справочники стран и категорий
            fetch('/api/metadata')
                .then(response => response.json())
                .then(data => {
                    const countrySelect = document.getElementById('batchCountry');
                    countrySelect.innerHTML = '<option value="">Все страны</option>';
                    data.countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        countrySelect.appendChild(option);
                    });

                    const categorySelect = document.getElementById('batchCategory');
                    categorySelect.innerHTML = '<option value="">Все категории</option>';
                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading metadata:', error));
        }

        function loadBatchEditEmails() {
            // Показываем загрузку
            const tbody = document.getElementById('batchEditTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Загрузка данных...</p>
                    </td>
                </tr>
            `;

            // Собираем параметры фильтрации
            const params = new URLSearchParams();
            const sourceFile = document.getElementById('batchSourceFile').value;
            const country = document.getElementById('batchCountry').value;
            const category = document.getElementById('batchCategory').value;
            const validationStatus = document.getElementById('batchValidationStatus').value;

            if (sourceFile) params.append('source_file', sourceFile);
            if (country) params.append('country', country);
            if (category) params.append('category', category);
            if (validationStatus) params.append('validation_status', validationStatus);
            params.append('limit', '10000'); // Загружаем больше данных для массовой обработки

            fetch(`/api/metadata-search?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    batchEditData = data.emails || [];
                    batchFilteredData = [...batchEditData];
                    batchCurrentPage = 1;
                    batchSelectedEmails.clear();

                    // Применяем клиентскую фильтрацию если есть поиск
                    filterBatchEmails();
                    renderBatchEditTable();
                    updateBatchStats();
                })
                .catch(error => {
                    console.error('Error loading batch emails:', error);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                                <p class="mt-2">Ошибка загрузки данных</p>
                            </td>
                        </tr>
                    `;
                });
        }

        function filterBatchEmails() {
            const searchTerm = document.getElementById('batchEmailSearch').value.toLowerCase();

            if (!searchTerm) {
                batchFilteredData = [...batchEditData];
            } else {
                batchFilteredData = batchEditData.filter(email =>
                    email.email.toLowerCase().includes(searchTerm) ||
                    (email.company_name && email.company_name.toLowerCase().includes(searchTerm)) ||
                    (email.domain && email.domain.toLowerCase().includes(searchTerm))
                );
            }

            batchCurrentPage = 1;
            renderBatchEditTable();
            updateBatchStats();
        }

        function debounceFilterBatchEmails() {
            clearTimeout(batchDebounceTimer);
            batchDebounceTimer = setTimeout(filterBatchEmails, 300);
        }

        function renderBatchEditTable() {
            const tbody = document.getElementById('batchEditTableBody');
            tbody.innerHTML = '';

            const startIndex = (batchCurrentPage - 1) * batchItemsPerPage;
            const endIndex = Math.min(startIndex + batchItemsPerPage, batchFilteredData.length);
            const pageData = batchFilteredData.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x"></i>
                            <p class="mt-2">Нет данных для отображения</p>
                        </td>
                    </tr>
                `;
                return;
            }

            pageData.forEach((email, idx) => {
                const globalIndex = startIndex + idx;
                const isChecked = batchSelectedEmails.has(email.email);

                const statusBadge = email.validation_status === 'Valid'
                    ? '<span class="badge bg-success">Valid</span>'
                    : email.validation_status === 'NotSure'
                    ? '<span class="badge bg-warning">NotSure</span>'
                    : email.validation_status === 'Temp'
                    ? '<span class="badge bg-info">Temp</span>'
                    : email.validation_status === 'Invalid'
                    ? '<span class="badge bg-danger">Invalid</span>'
                    : '<span class="badge bg-secondary">Unknown</span>';

                const row = document.createElement('tr');
                row.className = isChecked ? 'table-primary' : '';
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input batch-email-checkbox"
                               data-email="${email.email}" ${isChecked ? 'checked' : ''}
                               onchange="toggleEmailSelection('${email.email.replace(/'/g, "\\'")}')">
                    </td>
                    <td>${globalIndex + 1}</td>
                    <td class="text-break small">${email.email}</td>
                    <td class="small">${email.domain || '-'}</td>
                    <td class="small">${email.company_name || '-'}</td>
                    <td class="small">${email.source_file ? email.source_file.replace(/\.(lvp|json|csv|txt)$/i, '') : '-'}</td>
                    <td class="small">${email.country || '-'}</td>
                    <td class="small">${email.category || '-'}</td>
                    <td class="small">${email.phone || '-'}</td>
                    <td>${statusBadge}</td>
                `;

                tbody.appendChild(row);
            });

            // Обновляем пагинацию
            renderBatchPagination();
        }

        function renderBatchPagination() {
            const totalPages = Math.ceil(batchFilteredData.length / batchItemsPerPage);
            const pagination = document.getElementById('batchPagination');
            const paginationInfo = document.getElementById('batchPaginationInfo');

            paginationInfo.textContent = `Страница ${batchCurrentPage} из ${totalPages} (Показано ${Math.min((batchCurrentPage - 1) * batchItemsPerPage + batchItemsPerPage, batchFilteredData.length)} из ${batchFilteredData.length})`;

            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Предыдущая страница
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${batchCurrentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changeBatchPage(${batchCurrentPage - 1}); return false;">«</a>`;
            pagination.appendChild(prevLi);

            // Страницы
            const maxVisiblePages = 5;
            let startPage = Math.max(1, batchCurrentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === batchCurrentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="changeBatchPage(${i}); return false;">${i}</a>`;
                pagination.appendChild(pageLi);
            }

            // Следующая страница
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${batchCurrentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changeBatchPage(${batchCurrentPage + 1}); return false;">»</a>`;
            pagination.appendChild(nextLi);
        }

        function changeBatchPage(page) {
            const totalPages = Math.ceil(batchFilteredData.length / batchItemsPerPage);
            if (page < 1 || page > totalPages) return;

            batchCurrentPage = page;
            renderBatchEditTable();
        }

        function toggleEmailSelection(email) {
            if (batchSelectedEmails.has(email)) {
                batchSelectedEmails.delete(email);
            } else {
                batchSelectedEmails.add(email);
            }
            updateBatchStats();
            updateRowHighlight(email);
        }

        function updateRowHighlight(email) {
            const checkboxes = document.querySelectorAll('.batch-email-checkbox');
            checkboxes.forEach(cb => {
                if (cb.dataset.email === email) {
                    const row = cb.closest('tr');
                    if (batchSelectedEmails.has(email)) {
                        row.classList.add('table-primary');
                    } else {
                        row.classList.remove('table-primary');
                    }
                }
            });
        }

        function toggleSelectAllBatch() {
            const selectAllCheckbox = document.getElementById('batchSelectAll');
            const isChecked = selectAllCheckbox.checked;

            if (isChecked) {
                // Выбираем все отображаемые на текущей странице
                batchFilteredData.forEach(email => {
                    batchSelectedEmails.add(email.email);
                });
            } else {
                // Снимаем все выделения
                batchSelectedEmails.clear();
            }

            updateBatchStats();
            renderBatchEditTable();
        }

        function updateBatchStats() {
            document.getElementById('batchTotalCount').textContent = batchFilteredData.length;
            document.getElementById('batchSelectedCount').textContent = batchSelectedEmails.size;

            // Обновляем состояние чекбокса "Выбрать все"
            const selectAllCheckbox = document.getElementById('batchSelectAll');
            if (batchSelectedEmails.size === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (batchSelectedEmails.size === batchFilteredData.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        function clearBatchFilters() {
            document.getElementById('batchSourceFile').value = '';
            document.getElementById('batchCountry').value = '';
            document.getElementById('batchCategory').value = '';
            document.getElementById('batchValidationStatus').value = '';
            document.getElementById('batchEmailSearch').value = '';
            loadBatchEditEmails();
        }

        function applyBatchStatusUpdate() {
            const newStatus = document.getElementById('batchNewStatus').value;

            if (!newStatus) {
                alert('Выберите новый статус валидации');
                return;
            }

            if (batchSelectedEmails.size === 0) {
                alert('Выберите хотя бы один email для обновления');
                return;
            }

            if (!confirm(`Обновить статус валидации для ${batchSelectedEmails.size} email(s) на "${newStatus}"?`)) {
                return;
            }

            // Показываем индикатор загрузки
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обновление...';

            fetch('/api/metadata/batch-update-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    emails: Array.from(batchSelectedEmails),
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = originalText;

                if (data.success) {
                    alert(`✅ Успешно обновлено ${data.updated_count} записей`);

                    // Обновляем статусы в локальных данных
                    batchEditData.forEach(email => {
                        if (batchSelectedEmails.has(email.email)) {
                            email.validation_status = newStatus;
                        }
                    });

                    // Снимаем выделение
                    batchSelectedEmails.clear();

                    // Перерисовываем таблицу
                    renderBatchEditTable();
                    updateBatchStats();

                    // Сбрасываем выбор статуса
                    document.getElementById('batchNewStatus').value = '';
                } else {
                    alert(`❌ Ошибка обновления: ${data.message}`);
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                console.error('Error updating status:', error);
                alert('❌ Ошибка при обновлении статусов');
            });
        }

        function exportSelectedEmails() {
            if (batchSelectedEmails.size === 0) {
                alert('Выберите хотя бы один email для экспорта');
                return;
            }

            const selectedData = batchEditData.filter(email => batchSelectedEmails.has(email.email));

            // Экспортируем в CSV
            const headers = ['Email', 'Domain', 'Company', 'Country', 'Category', 'Phone', 'Validation Status', 'Source File'];
            const csvData = [headers.join(',')];

            selectedData.forEach(email => {
                const row = [
                    email.email || '',
                    email.domain || '',
                    email.company_name || '',
                    email.country || '',
                    email.category || '',
                    email.phone || '',
                    email.validation_status || '',
                    email.source_file || ''
                ].map(field => `"${String(field).replace(/"/g, '""')}"`);

                csvData.push(row.join(','));
            });

            const csvContent = csvData.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `selected_emails_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        // ========== Validation Status Filter Functions ==========

        function getSelectedValidationStatuses() {
            const checkboxes = document.querySelectorAll('.validation-status-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function updateValidationFilter() {
            const selected = getSelectedValidationStatuses();
            const label = document.getElementById('validationFilterLabel');

            if (selected.length === 0) {
                label.textContent = 'Все';
            } else if (selected.length === 1) {
                label.textContent = selected[0];
            } else if (selected.length === 4) {
                label.textContent = 'Все';
            } else {
                label.textContent = `${selected.length} выбрано`;
            }

            // Trigger filter
            filterEmails();
        }

        function invertStatusSelection() {
            const checkboxes = document.querySelectorAll('.validation-status-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = !cb.checked;
            });
            updateValidationFilter();
        }

        function clearStatusSelection() {
            const checkboxes = document.querySelectorAll('.validation-status-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            updateValidationFilter();
        }

        // ========== LVP Export Functions ==========

        function showLVPExportModal() {
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('lvpExportModal'));
            modal.show();

            // Update filtered export display
            updateLVPFilterDisplay();

            // Add radio button listener
            document.querySelectorAll('input[name="lvpExportType"]').forEach(radio => {
                radio.addEventListener('change', updateLVPFilterDisplay);
            });
        }

        function updateLVPFilterDisplay() {
            const isFiltered = document.getElementById('lvpExportFiltered')?.checked;
            const filterOptionsDiv = document.getElementById('lvpFilterOptions');
            const filterDisplayDiv = document.getElementById('lvpActiveFiltersDisplay');

            if (!filterOptionsDiv || !filterDisplayDiv) {
                return; // Exit if elements not found
            }

            if (isFiltered) {
                filterOptionsDiv.style.display = 'block';

                // Collect active filters
                const activeFilters = [];
                const country = document.getElementById('countryFilter')?.value;
                const category = document.getElementById('categoryFilter')?.value;
                const validationStatuses = getSelectedValidationStatuses();
                const sourceFile = document.getElementById('sourceFileFilter')?.value;

                if (country) activeFilters.push(`<strong>Страна:</strong> ${country}`);
                if (category) activeFilters.push(`<strong>Категория:</strong> ${category}`);
                if (validationStatuses && validationStatuses.length > 0) {
                    activeFilters.push(`<strong>Статус:</strong> ${validationStatuses.join(', ')}`);
                }
                if (sourceFile) activeFilters.push(`<strong>Источник:</strong> ${sourceFile}`);

                if (activeFilters.length > 0) {
                    filterDisplayDiv.innerHTML = activeFilters.join('<br>');
                } else {
                    filterDisplayDiv.innerHTML = '<em>Нет активных фильтров</em>';
                }
            } else {
                filterOptionsDiv.style.display = 'none';
            }
        }

        function executeLVPExport() {
            const exportBtn = document.getElementById('lvpExportBtn');
            const progressDiv = document.getElementById('lvpExportProgress');

            // Show progress
            exportBtn.disabled = true;
            progressDiv.style.display = 'block';

            // Collect parameters
            const isFiltered = document.getElementById('lvpExportFiltered').checked;
            const limit = document.getElementById('lvpExportLimit').value;

            const requestBody = {};

            // Add limit if specified
            if (limit) {
                requestBody.limit = parseInt(limit);
            }

            // Add filters if filtered export
            if (isFiltered) {
                const country = document.getElementById('countryFilter')?.value;
                const category = document.getElementById('categoryFilter')?.value;
                const validationStatuses = getSelectedValidationStatuses();
                const sourceFile = document.getElementById('sourceFileFilter')?.value;

                if (country) requestBody.country = country;
                if (category) requestBody.category = category;
                if (validationStatuses.length > 0) {
                    requestBody.validation_status = validationStatuses.join(',');
                }
                if (sourceFile) requestBody.source_file = sourceFile;
            }

            // Execute export
            fetch('/api/export-lvp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                exportBtn.disabled = false;
                progressDiv.style.display = 'none';

                if (data.success) {
                    alert(`✅ Экспорт завершен!\n\nВсего экспортировано: ${data.total_exported} email\nФайл: ${data.filename}`);

                    // Download the file
                    window.location.href = data.download_url;

                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('lvpExportModal')).hide();
                } else {
                    alert(`❌ Ошибка экспорта:\n${data.error}`);
                }
            })
            .catch(error => {
                exportBtn.disabled = false;
                progressDiv.style.display = 'none';
                console.error('Error during LVP export:', error);
                alert('❌ Ошибка при экспорте в LVP');
            });
        }

        // ==================== ПРОСМОТР РЕЗУЛЬТАТОВ ====================

        let currentResults = null;  // Текущие результаты для работы с файлами

        function viewResults(filename) {
            console.log('Opening results for:', filename);

            // Загрузка списка выходных файлов
            fetch(`/api/output-files?list=${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Ошибка: ${data.error}`);
                        return;
                    }

                    currentResults = data;
                    document.getElementById('resultsListName').textContent = data.list_name;

                    // Обновляем счетчики
                    updateResultCounts(data.files);

                    // Загружаем предпросмотр для clean файлов
                    loadFilePreview('clean');

                    // Показываем модальное окно
                    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error loading results:', error);
                    alert('Ошибка загрузки результатов');
                });
        }

        function updateResultCounts(files) {
            // Clean files
            const cleanCount = files.clean.reduce((sum, f) => sum + (f.email_count || 0), 0);
            document.getElementById('cleanCount').textContent = cleanCount.toLocaleString();

            // Blocked files (email + domain)
            const blockedCount = files.blocked_email.reduce((sum, f) => sum + (f.email_count || 0), 0) +
                                 files.blocked_domain.reduce((sum, f) => sum + (f.email_count || 0), 0);
            document.getElementById('blockedCount').textContent = blockedCount.toLocaleString();

            // Metadata files
            const metadataCount = files.metadata_json.length + files.metadata_csv.length;
            document.getElementById('metadataCount').textContent = metadataCount;
        }

        function loadFilePreview(type) {
            if (!currentResults) {
                console.warn('No current results to preview');
                return;
            }

            let files = [];
            let previewId = '';
            let truncatedId = '';
            let totalId = '';

            switch(type) {
                case 'clean':
                    files = currentResults.files.clean;
                    previewId = 'cleanPreview';
                    truncatedId = 'cleanTruncated';
                    totalId = 'cleanTotal';
                    break;
                case 'blocked':
                    files = currentResults.files.blocked_email.concat(currentResults.files.blocked_domain);
                    previewId = 'blockedPreview';
                    truncatedId = 'blockedTruncated';
                    totalId = 'blockedTotal';
                    break;
                case 'metadata-json':
                    files = currentResults.files.metadata_json;
                    previewId = 'metadataPreview';
                    break;
                case 'metadata-csv':
                    files = currentResults.files.metadata_csv;
                    previewId = 'metadataPreview';
                    break;
            }

            if (files.length === 0) {
                document.getElementById(previewId).textContent = 'Нет файлов для отображения';
                return;
            }

            // Берем первый файл
            const file = files[0];

            // Показываем индикатор загрузки
            document.getElementById(previewId).textContent = 'Загрузка...';

            fetch(`/api/file-preview?path=${encodeURIComponent(file.path)}&lines=100`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById(previewId).textContent = `Ошибка: ${data.error}`;
                        return;
                    }

                    document.getElementById(previewId).textContent = data.content;

                    // Показываем информацию о truncation
                    if (data.truncated && truncatedId) {
                        document.getElementById(truncatedId).style.display = 'block';
                        document.getElementById(totalId).textContent = data.total_lines.toLocaleString();
                    } else if (truncatedId) {
                        document.getElementById(truncatedId).style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading preview:', error);
                    document.getElementById(previewId).textContent = 'Ошибка загрузки предпросмотра';
                });
        }

        function downloadResultFile(type) {
            if (!currentResults) {
                alert('Нет результатов для скачивания');
                return;
            }

            let files = [];

            switch(type) {
                case 'clean':
                    files = currentResults.files.clean;
                    break;
                case 'blocked':
                    files = currentResults.files.blocked_email.concat(currentResults.files.blocked_domain);
                    break;
                case 'metadata-json':
                    files = currentResults.files.metadata_json;
                    break;
                case 'metadata-csv':
                    files = currentResults.files.metadata_csv;
                    break;
            }

            if (files.length === 0) {
                alert('Нет файлов для скачивания');
                return;
            }

            // Скачиваем первый файл
            const file = files[0];
            window.location.href = `/api/download-file?path=${encodeURIComponent(file.path)}`;
        }

        function openHtmlReport() {
            if (!currentResults) {
                alert('Нет результатов');
                return;
            }

            const reportFiles = currentResults.files.report_html;
            if (reportFiles.length === 0) {
                alert('HTML отчет не найден. Возможно, обработка была выполнена без флага --generate-html');
                return;
            }

            // Открываем первый отчет в новой вкладке
            const report = reportFiles[0];
            window.open(`/${report.path}`, '_blank');
        }

        // Обработчик переключения вкладок для lazy loading
        document.getElementById('resultsModal')?.addEventListener('shown.bs.tab', function (event) {
            const tabId = event.target.id;

            switch(tabId) {
                case 'clean-tab':
                    loadFilePreview('clean');
                    break;
                case 'blocked-tab':
                    loadFilePreview('blocked');
                    break;
                case 'metadata-tab':
                    loadFilePreview('metadata-json');
                    break;
            }
        });

        // ===== ФУНКЦИИ АДМИН-ПАНЕЛИ =====

        function showAdminPanel() {
            const modal = new bootstrap.Modal(document.getElementById('adminPanel'));
            modal.show();

            // Загружаем данные при открытии
            loadAdminStats();
            loadAdminFiles();
        }

        async function loadAdminStats() {
            const statsContent = document.getElementById('adminStatsContent');
            statsContent.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка статистики...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/admin/stats');
                if (!response.ok) throw new Error('Ошибка загрузки статистики');

                const data = await response.json();
                displayAdminStats(data.stats);
            } catch (error) {
                statsContent.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
            }
        }

        function displayAdminStats(stats) {
            const statsContent = document.getElementById('adminStatsContent');

            // Вспомогательная функция для безопасного форматирования чисел
            const safeNumber = (val) => {
                if (val === undefined || val === null || isNaN(val)) return 0;
                return Number(val);
            };

            const safeString = (val) => val || 'N/A';

            let html = '<div class="row">';

            // Статистика кеша
            html += '<div class="col-md-6 mb-3">';
            html += '<div class="card border-info">';
            html += '<div class="card-body">';
            html += '<h6 class="card-title"><i class="fas fa-hdd"></i> Кеш обработки</h6>';
            if (stats.cache && stats.cache.exists) {
                html += `<p><strong>Файлов кешировано:</strong> ${safeNumber(stats.cache.files_cached).toLocaleString()}</p>`;
                html += `<p><strong>Размер:</strong> ${formatFileSize(safeNumber(stats.cache.size))}</p>`;
                html += `<p class="text-muted small">${safeString(stats.cache.path)}</p>`;
            } else {
                html += '<p class="text-muted">Кеш не найден</p>';
            }
            html += '</div></div></div>';

            // Статистика БД
            html += '<div class="col-md-6 mb-3">';
            html += '<div class="card border-primary">';
            html += '<div class="card-body">';
            html += '<h6 class="card-title"><i class="fas fa-database"></i> База данных метаданных</h6>';
            if (stats.database && stats.database.exists) {
                if (stats.database.error) {
                    html += `<p class="text-danger"><strong>Ошибка:</strong> ${stats.database.error}</p>`;
                    html += `<p><strong>Размер:</strong> ${formatFileSize(safeNumber(stats.database.size))}</p>`;
                } else {
                    html += `<p><strong>Email в БД:</strong> ${safeNumber(stats.database.email_count).toLocaleString()}</p>`;
                    html += `<p><strong>Размер:</strong> ${formatFileSize(safeNumber(stats.database.size))}</p>`;
                }
                html += `<p class="text-muted small">${safeString(stats.database.path)}</p>`;
            } else {
                html += '<p class="text-muted">БД не найдена</p>';
            }
            html += '</div></div></div>';

            // Статистика директорий
            html += '<div class="col-md-6 mb-3">';
            html += '<div class="card border-success">';
            html += '<div class="card-body">';
            html += '<h6 class="card-title"><i class="fas fa-folder"></i> Директория input/</h6>';
            if (stats.directories && stats.directories.input) {
                html += `<p><strong>Файлов:</strong> ${safeNumber(stats.directories.input.files).toLocaleString()}</p>`;
                html += `<p><strong>Размер:</strong> ${formatFileSize(safeNumber(stats.directories.input.size))}</p>`;
            } else {
                html += '<p class="text-muted">Нет данных</p>';
            }
            html += '</div></div></div>';

            html += '<div class="col-md-6 mb-3">';
            html += '<div class="card border-warning">';
            html += '<div class="card-body">';
            html += '<h6 class="card-title"><i class="fas fa-folder-open"></i> Директория output/</h6>';
            if (stats.directories && stats.directories.output) {
                html += `<p><strong>Файлов:</strong> ${safeNumber(stats.directories.output.files).toLocaleString()}</p>`;
                html += `<p><strong>Размер:</strong> ${formatFileSize(safeNumber(stats.directories.output.size))}</p>`;
            } else {
                html += '<p class="text-muted">Нет данных</p>';
            }
            html += '</div></div></div>';

            // Статистика дискового пространства
            html += '<div class="col-12">';
            html += '<div class="card border-danger">';
            html += '<div class="card-body">';
            html += '<h6 class="card-title"><i class="fas fa-server"></i> Дисковое пространство</h6>';
            if (stats.disk) {
                html += '<div class="row">';
                html += `<div class="col-md-3"><strong>Всего:</strong> ${formatFileSize(safeNumber(stats.disk.total))}</div>`;
                html += `<div class="col-md-3"><strong>Использовано:</strong> ${formatFileSize(safeNumber(stats.disk.used))}</div>`;
                html += `<div class="col-md-3"><strong>Свободно:</strong> ${formatFileSize(safeNumber(stats.disk.free))}</div>`;
                html += `<div class="col-md-3"><strong>Использовано:</strong> ${safeNumber(stats.disk.percent_used).toFixed(1)}%</div>`;
                html += '</div>';
                const percent = safeNumber(stats.disk.percent_used);
                html += '<div class="progress mt-3" style="height: 25px;">';
                html += `<div class="progress-bar ${percent > 90 ? 'bg-danger' : percent > 75 ? 'bg-warning' : 'bg-success'}" role="progressbar" style="width: ${percent}%">${percent.toFixed(1)}%</div>`;
                html += '</div>';
            } else {
                html += '<p class="text-muted">Нет данных</p>';
            }
            html += '</div></div></div>';

            html += '</div>';

            statsContent.innerHTML = html;
        }

        async function clearCache() {
            if (!confirm('Вы уверены, что хотите очистить кеш? Это приведет к повторной обработке всех файлов при следующем запуске.')) {
                return;
            }

            const resultDiv = document.getElementById('clearCacheResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Очистка кеша...</div>';

            try {
                const response = await fetch('/api/admin/clear-cache', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                if (!response.ok) throw new Error('Ошибка очистки кеша');

                const data = await response.json();
                resultDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> ${data.message}</div>`;

                // Обновляем статистику
                loadAdminStats();
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Ошибка: ${error.message}</div>`;
            }
        }

        async function optimizeDatabase() {
            if (!confirm('Оптимизация базы данных может занять несколько минут. Продолжить?')) {
                return;
            }

            const resultDiv = document.getElementById('optimizeDbResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Оптимизация базы данных... Пожалуйста, подождите.</div>';

            try {
                const response = await fetch('/api/admin/optimize-db', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Ошибка оптимизации');
                }

                const data = await response.json();

                let message = `<div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> ${data.message}<br>
                    <strong>Размер до:</strong> ${formatFileSize(data.size_before)}<br>
                    <strong>Размер после:</strong> ${formatFileSize(data.size_after)}<br>
                    <strong>Освобождено:</strong> ${formatFileSize(data.saved)} (${data.percent_saved}%)
                </div>`;

                resultDiv.innerHTML = message;

                // Обновляем статистику
                loadAdminStats();
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Ошибка: ${error.message}</div>`;
            }
        }

        async function loadAdminFiles() {
            const inputDiv = document.getElementById('inputFilesList');
            const outputDiv = document.getElementById('outputFilesList');

            inputDiv.innerHTML = '<p class="text-muted">Загрузка...</p>';
            outputDiv.innerHTML = '<p class="text-muted">Загрузка...</p>';

            try {
                const response = await fetch('/api/all-files');
                if (!response.ok) throw new Error('Ошибка загрузки файлов');

                const data = await response.json();

                // Проверяем формат данных
                if (!data.files || !Array.isArray(data.files)) {
                    throw new Error('Некорректный формат данных от сервера');
                }

                // Разделяем на input/ и output/
                const inputFiles = data.files.filter(f => f.path && f.path.startsWith('input/'));
                const outputFiles = data.files.filter(f => f.path && f.path.startsWith('output/'));

                // Отображаем input файлы
                if (inputFiles.length > 0) {
                    inputDiv.innerHTML = '<div class="list-group">' +
                        inputFiles.map(file => {
                            const fileName = file.name || file.path.split('/').pop();
                            const fileSize = file.size !== undefined ? formatFileSize(file.size) : 'N/A';
                            return `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="fas fa-file"></i> ${fileName}
                                    <br><small class="text-muted">${fileSize}</small>
                                </span>
                                <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.path}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>`;
                        }).join('') + '</div>';
                } else {
                    inputDiv.innerHTML = '<p class="text-muted">Нет файлов</p>';
                }

                // Отображаем output файлы (лимит 50 файлов для производительности)
                if (outputFiles.length > 0) {
                    const displayFiles = outputFiles.slice(0, 50);
                    let html = '<div class="list-group">';

                    if (outputFiles.length > 50) {
                        html += `<div class="alert alert-info mb-2">Показаны первые 50 из ${outputFiles.length} файлов</div>`;
                    }

                    html += displayFiles.map(file => {
                        const fileName = file.name || file.path.split('/').pop();
                        const fileSize = file.size !== undefined ? formatFileSize(file.size) : 'N/A';
                        return `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="fas fa-file"></i> ${fileName}
                                    <br><small class="text-muted">${fileSize}</small>
                                </span>
                                <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.path}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>`;
                    }).join('') + '</div>';

                    outputDiv.innerHTML = html;
                } else {
                    outputDiv.innerHTML = '<p class="text-muted">Нет файлов</p>';
                }
            } catch (error) {
                console.error('Error loading admin files:', error);
                inputDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
                outputDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
            }
        }

        async function deleteFile(filePath) {
            if (!confirm(`Вы уверены, что хотите удалить файл ${filePath}?`)) {
                return;
            }

            const resultDiv = document.getElementById('deleteFileResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Удаление файла...</div>';

            try {
                const response = await fetch('/api/admin/delete-file', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path: filePath})
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Ошибка удаления файла');
                }

                const data = await response.json();
                resultDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> ${data.message}</div>`;

                // Обновляем списки файлов
                loadAdminFiles();

                // Обновляем статистику
                loadAdminStats();

                // Обновляем основной список если удален input файл
                if (filePath.startsWith('input/')) {
                    loadLists();
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Ошибка: ${error.message}</div>`;
            }
        }

    </script>
</body>
</html>