# Руководство по восстановлению Email Checker

Это руководство описывает процедуры диагностики, сброса и восстановления системы Email Checker при возникновении проблем с данными или конфигурацией.

## Содержание

1. [Диагностика проблем](#диагностика-проблем)
2. [Сброс системы](#сброс-системы)
3. [Восстановление данных](#восстановление-данных)
4. [Типичные проблемы и решения](#типичные-проблемы-и-решения)
5. [API Reference](#api-reference)

---

## Диагностика проблем

### Проверка состояния системы

```bash
# Проверка размера кеша
ls -lh .cache/processed_files.json

# Проверка размера БД метаданных
ls -lh metadata.db

# Количество файлов в input/
ls input/ | wc -l

# Количество файлов в output/
ls output/ | wc -l

# Проверка конфигурации
python -m json.tool lists_config.json | head -50
```

### Симптомы проблем

**Проблема 1: Ошибки JavaScript в веб-интерфейсе**
- Симптом: "cannot read properties of undefined"
- Причина: Некорректные данные в ответах API
- Решение: Исправлены в последней версии [email_list_manager.html](email_list_manager.html)

**Проблема 2: Устаревший кеш**
- Симптом: Файлы не обрабатываются повторно
- Причина: Большой кеш с устаревшими хешами
- Решение: Очистка кеша (см. ниже)

**Проблема 3: Несоответствие конфигурации и файлов**
- Симптом: В `lists_config.json` есть файлы, которых нет в input/
- Причина: Файлы удалены вручную без обновления конфига
- Решение: Пересоздание конфигурации (см. ниже)

**Проблема 4: Отсутствие метаданных в TXT файлах**
- Симптом: TXT файлы обработаны без метаданных компаний
- Причина: LVP файлы не были импортированы в metadata.db
- Решение: Полное восстановление данных (см. ниже)

---

## Сброс системы

### Использование командной строки

Скрипт [reset_system.py](reset_system.py) предоставляет гибкие опции сброса:

#### Очистка кеша

```bash
python reset_system.py --clean-cache --backup
```

Удаляет `.cache/processed_files.json`. Все файлы будут обработаны заново при следующем запуске.

#### Пересоздание конфигурации

```bash
python reset_system.py --clean-config --backup
```

Пересоздаёт `lists_config.json` на основе текущих файлов в input/. Автоопределяет:
- Страну (из имени файла)
- Категорию (Automotive, Agriculture, Manufacturing и т.д.)
- Тип файла (txt, lvp)

#### Очистка output/

```bash
python reset_system.py --clean-output --backup
```

**⚠️ ОСТОРОЖНО:** Удаляет ВСЕ обработанные файлы из output/!

#### Очистка БД метаданных

```bash
python reset_system.py --clean-metadata-db --backup
```

**⚠️ ОСТОРОЖНО:** Удаляет всю БД метаданных (181MB+). Потребуется повторный импорт LVP файлов.

#### Полный сброс

```bash
python reset_system.py --full-reset --backup
```

**⚠️ КРИТИЧЕСКИ ВАЖНО:** Выполняет ВСЕ операции сброса:
- Очищает кеш
- Пересоздаёт конфигурацию
- Удаляет output/
- Удаляет metadata.db

**Резервная копия создаётся автоматически** в `backups/backup_YYYYMMDD_HHMMSS/`

#### Сброс без резервной копии

```bash
python reset_system.py --full-reset --no-backup
```

**⚠️ ОПАСНО:** Выполняет сброс БЕЗ создания резервной копии!

### Использование веб-интерфейса

1. Откройте админ-панель: `http://localhost:8082` → кнопка "Админ-панель"
2. В секции управления системой выберите опции
3. Нажмите соответствующую кнопку

### Использование API

```bash
# Полный сброс с резервной копией
curl -X POST http://localhost:8082/api/admin/reset-system \
  -H "Content-Type: application/json" \
  -d '{
    "full_reset": true,
    "backup": true
  }'

# Выборочный сброс
curl -X POST http://localhost:8082/api/admin/reset-system \
  -H "Content-Type: application/json" \
  -d '{
    "clean_cache": true,
    "clean_config": true,
    "backup": true
  }'
```

---

## Восстановление данных

### Рекомендуемый процесс

Скрипт [restore_data.py](restore_data.py) выполняет пошаговое восстановление всех данных.

#### Полное восстановление (Рекомендуется)

```bash
python restore_data.py --all --unified
```

**Что происходит:**
1. **Шаг 1:** Импорт всех LVP файлов из input/ в metadata.db
2. **Шаг 2:** Единая обработка всех файлов (TXT + LVP)
   - Обрабатывает TXT файлы
   - Обрабатывает LVP файлы с метаданными
   - Выполняет кросс-дедупликацию между всеми типами
   - Генерирует единый HTML отчёт

**Преимущества:**
- ✅ Метаданные из LVP автоматически обогащают TXT файлы
- ✅ Полная дедупликация между всеми списками
- ✅ Единый отчёт со всей статистикой

**Время выполнения:** 30-60 минут в зависимости от количества файлов

#### Раздельная обработка

```bash
python restore_data.py --all
```

Выполняет раздельную обработку LVP и TXT файлов (без флага `--unified`).

**Что происходит:**
1. Импорт LVP в metadata.db
2. Обработка LVP файлов отдельно
3. Обработка TXT файлов отдельно с обогащением

**Когда использовать:** Если вам нужны отдельные отчёты для каждого типа файлов.

#### Пошаговая обработка

Для отладки или экспериментов:

```bash
# Только импорт LVP в БД
python restore_data.py --step1

# Только обработка LVP файлов
python restore_data.py --step2

# Только обработка TXT файлов с обогащением
python restore_data.py --step3

# Только единая обработка
python restore_data.py --step4
```

### Использование веб-интерфейса

**Восстановление через API (веб-интерфейс в разработке):**

1. Откройте терминал и запустите восстановление:
   ```bash
   python restore_data.py --all --unified
   ```

2. Следите за прогрессом в консоли

### Использование API

```bash
# Полное восстановление (единая обработка)
curl -X POST http://localhost:8082/api/admin/restore-data \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "all",
    "unified": true
  }'

# Только импорт LVP
curl -X POST http://localhost:8082/api/admin/restore-data \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "step1"
  }'

# Проверка статуса
curl http://localhost:8082/api/processing-status
```

---

## Типичные проблемы и решения

### Проблема 1: "Файлов кешировано: 200, но в input/ только 50 файлов"

**Симптом:** Устаревший кеш со старыми файлами

**Решение:**
```bash
python reset_system.py --clean-cache --clean-config --backup
```

---

### Проблема 2: "TXT файлы обработаны, но нет метаданных компаний"

**Симптом:** Обработка выполнена до импорта LVP файлов

**Решение:**
```bash
# 1. Очистить output для TXT файлов
rm output/*FullList*

# 2. Импортировать LVP
python restore_data.py --step1

# 3. Переобработать TXT файлы с обогащением
python restore_data.py --step3
```

---

### Проблема 3: "Дубликаты между LVP и TXT списками"

**Симптом:** Email присутствует в нескольких выходных файлах

**Решение:**
```bash
# Полная переобработка с единой дедупликацией
python reset_system.py --clean-output --backup
python restore_data.py --all --unified
```

---

### Проблема 4: "БД метаданных 181MB, но медленно работает"

**Симптом:** Большой размер БД из-за фрагментации

**Решение через веб-интерфейс:**
1. Админ-панель → "Оптимизировать БД"

**Решение через командную строку:**
```bash
sqlite3 metadata.db "VACUUM;"
```

**Ожидаемый результат:** Экономия 5-20% места, ускорение запросов

---

### Проблема 5: "Файл в input/, но не в lists_config.json"

**Симптом:** Загружен новый файл вручную

**Решение:**
```bash
python reset_system.py --clean-config --backup
```

Автоматически обнаружит все файлы в input/ и создаст корректную конфигурацию.

---

### Проблема 6: "Ошибка: cannot read properties of undefined (reading 'toLocaleString')"

**Симптом:** JavaScript ошибка в админ-панели

**Решение:** Обновите [email_list_manager.html](email_list_manager.html#L4195-4287) до последней версии с исправлениями.

Исправления включают:
- Безопасное форматирование чисел
- Проверки на undefined/null
- Обработка ошибок БД

---

## API Reference

### Admin Endpoints

#### GET `/api/admin/stats`

Получение детальной статистики системы.

**Ответ:**
```json
{
  "stats": {
    "cache": {
      "exists": true,
      "files_cached": 150,
      "size": 17825792,
      "path": ".cache/processed_files.json"
    },
    "database": {
      "exists": true,
      "size": 189693952,
      "email_count": 2500000,
      "path": "metadata.db"
    },
    "directories": {
      "input": { "files": 50, "size": 268435456 },
      "output": { "files": 932, "size": 536870912 }
    },
    "disk": {
      "total": 1000000000000,
      "used": 500000000000,
      "free": 500000000000,
      "percent_used": 50.0
    }
  }
}
```

---

#### POST `/api/admin/clear-cache`

Очистка кеша обработки.

**Запрос:** Пустое тело или `{}`

**Ответ:**
```json
{
  "success": true,
  "message": "Кеш успешно очищен"
}
```

---

#### POST `/api/admin/optimize-db`

Оптимизация БД метаданных (VACUUM).

**Запрос:** Пустое тело или `{}`

**Ответ:**
```json
{
  "success": true,
  "message": "БД успешно оптимизирована",
  "size_before": 189693952,
  "size_after": 170000000,
  "saved": 19693952,
  "percent_saved": 10.38
}
```

---

#### POST `/api/admin/delete-file`

Удаление файла из input/ или output/.

**Запрос:**
```json
{
  "path": "input/example.txt"
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "Файл example.txt успешно удален"
}
```

**Примечание:** При удалении из input/ автоматически обновляется lists_config.json

---

#### POST `/api/admin/reset-system`

Сброс системы через reset_system.py.

**Запрос:**
```json
{
  "full_reset": false,
  "clean_cache": true,
  "clean_config": true,
  "clean_output": false,
  "clean_metadata_db": false,
  "backup": true
}
```

**Параметры:**
- `full_reset` (bool): Полный сброс всей системы
- `clean_cache` (bool): Очистить кеш
- `clean_config` (bool): Пересоздать конфигурацию
- `clean_output` (bool): Удалить output/
- `clean_metadata_db` (bool): Удалить БД метаданных
- `backup` (bool): Создать резервную копию (по умолчанию true)

**Ответ:**
```json
{
  "success": true,
  "message": "Сброс системы запущен"
}
```

---

#### POST `/api/admin/restore-data`

Восстановление данных через restore_data.py.

**Запрос:**
```json
{
  "mode": "all",
  "unified": true
}
```

**Параметры:**
- `mode` (string): Режим восстановления
  - `"all"` - полное восстановление
  - `"step1"` - только импорт LVP
  - `"step2"` - только обработка LVP
  - `"step3"` - только обработка TXT
  - `"step4"` - только единая обработка
- `unified` (bool): Использовать единую обработку (только для mode="all")

**Ответ:**
```json
{
  "success": true,
  "message": "Восстановление данных запущено (режим: all, единая обработка)"
}
```

**Примечание:** Процесс запускается в фоне. Используйте `/api/processing-status` для отслеживания прогресса.

---

## Резервное копирование

### Автоматические резервные копии

Скрипты создают резервные копии автоматически при использовании флага `--backup`:

**Директория:** `backups/backup_YYYYMMDD_HHMMSS/`

**Содержимое:**
- `processed_files.json` - кеш обработки
- `lists_config.json` - конфигурация списков
- `metadata.db` - БД метаданных (если есть)
- `backup_info.json` - информация о резервной копии

**Пример:**
```
backups/
  backup_20251006_143022/
    processed_files.json
    lists_config.json
    metadata.db
    backup_info.json
```

### Восстановление из резервной копии

```bash
# 1. Найдите нужную резервную копию
ls -lt backups/

# 2. Скопируйте файлы обратно
cp backups/backup_20251006_143022/processed_files.json .cache/
cp backups/backup_20251006_143022/lists_config.json .
cp backups/backup_20251006_143022/metadata.db .
```

---

## Лучшие практики

### Перед полным сбросом

1. ✅ Создайте резервную копию (используйте `--backup`)
2. ✅ Проверьте наличие всех файлов в input/
3. ✅ Убедитесь, что нет запущенных процессов обработки
4. ✅ Запланируйте 30-60 минут на восстановление

### После восстановления

1. ✅ Проверьте HTML отчёт в output/
2. ✅ Убедитесь, что количество обработанных email соответствует ожиданиям
3. ✅ Проверьте наличие метаданных в CSV/JSON файлах
4. ✅ Проверьте размер metadata.db (должен быть ~150-200MB для больших списков)

### Регулярное обслуживание

**Еженедельно:**
- Проверяйте размер кеша и output/
- Оптимизируйте БД при необходимости

**Ежемесячно:**
- Очищайте старые резервные копии
- Проверяйте актуальность lists_config.json

---

## Поддержка

Если проблема не решается с помощью этого руководства:

1. Проверьте логи веб-сервера
2. Запустите скрипты с флагом `--help` для подробной информации
3. Создайте issue с описанием проблемы и логами

---

**Последнее обновление:** 06.10.2025
**Версия:** 1.0
