# Руководство по валидации доменов

## Зачем проверять домены перед парсингом?

✅ **Преимущества валидации доменов:**
- Экономия времени - не парсим несуществующие сайты
- Экономия ресурсов - меньше HTTP запросов
- Чистые данные - только рабочие домены в финальной базе
- Приоритизация - парсим сначала HTTPS сайты (более надежные)

## Использование скрипта

### Базовая проверка (только стандартная библиотека Python)

```bash
# Проверка всех доменов
python validate_domains.py output/POST_SOVIET_DOMAINS_NO_METADATA.txt

# С настройками производительности
python validate_domains.py output/POST_SOVIET_DOMAINS_NO_METADATA.txt --threads 50 --timeout 5

# Тестирование на первых 100 доменах
python validate_domains.py output/POST_SOVIET_DOMAINS_NO_METADATA.txt --limit 100
```

### Параметры запуска

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `input_file` | Файл со списком доменов | (обязательный) |
| `--threads` | Количество параллельных потоков | 50 |
| `--timeout` | Таймаут для каждого запроса (сек) | 5 |
| `--limit` | Ограничить количество доменов (тест) | нет |
| `--output-dir` | Директория для результатов | output/domain_validation |

### Рекомендуемые настройки

**Для 10K+ доменов:**
```bash
python validate_domains.py output/POST_SOVIET_DOMAINS_NO_METADATA.txt \
    --threads 100 \
    --timeout 3
```

**Для медленного интернета:**
```bash
python validate_domains.py output/POST_SOVIET_DOMAINS_NO_METADATA.txt \
    --threads 20 \
    --timeout 10
```

## Что проверяет скрипт?

### 1. DNS валидация ✓
- Проверяет, резолвится ли домен в IP адрес
- Быстрая проверка существования домена
- Фильтрует несуществующие/истекшие домены

### 2. HTTP проверка ✓
- Проверяет доступность через HTTP (port 80)
- Возвращает статус код (200, 404, 500 и т.д.)
- Определяет, работает ли веб-сайт

### 3. HTTPS проверка ✓
- Проверяет доступность через HTTPS (port 443)
- Важно для современных сайтов
- Более надежный канал для парсинга

## Результаты проверки

Скрипт создает 4-5 файлов в `output/domain_validation/`:

### 1. VALID_DOMAINS_*.txt
**Готовые к парсингу домены** - DNS OK и HTTP/HTTPS доступен

```
02agro.ru
1-turist.ru
100-tonn.ru
1000dopov.ru
...
```

### 2. VALIDATION_REPORT_*.json
**Полный JSON отчет** со всеми данными:
```json
{
  "timestamp": "20251117_124355",
  "stats": {
    "total": 50,
    "dns_ok": 46,
    "dns_fail": 4,
    "http_ok": 44,
    "https_ok": 43
  },
  "valid_domains": [...],
  "invalid_dns": [...],
  "invalid_http": [...]
}
```

### 3. VALIDATION_DETAILS_*.csv
**Детальная таблица** для анализа:
```csv
Domain,DNS_OK,IP_Address,HTTP_OK,HTTPS_OK,HTTP_Status,HTTPS_Status,Is_Valid,Message
02agro.ru,True,176.57.65.235,True,True,200,200,True,"DNS: 176.57.65.235, HTTP: 200, HTTPS: 200"
```

### 4. INVALID_DNS_*.txt (если есть)
**Невалидные DNS** - домены не существуют:
```
16start.ru	DNS error: [Errno 11001] getaddrinfo failed
1kmz.ru	DNS error: [Errno 11002] getaddrinfo failed
```

### 5. INVALID_HTTP_*.txt (если есть)
**DNS OK, но HTTP недоступен** - домен зарегистрирован, но сайт не работает

## Интерпретация результатов

### Статусы доменов

| Статус | DNS | HTTP | HTTPS | Действие |
|--------|-----|------|-------|----------|
| ✅ Готов к парсингу | ✓ | ✓ | ✓ | Парсить в первую очередь |
| ✅ Готов (только HTTP) | ✓ | ✓ | ✗ | Парсить через HTTP |
| ⚠️ DNS OK, сайт недоступен | ✓ | ✗ | ✗ | Пропустить или повторить позже |
| ❌ Домен не существует | ✗ | - | - | Удалить из базы |

### Типичные результаты для постсоветских доменов

**Ожидаемая статистика:**
- 85-95% доменов - DNS OK
- 75-85% доменов - HTTP доступен
- 60-75% доменов - HTTPS доступен
- 5-15% доменов - не существуют

## Производительность

### Скорость проверки

| Доменов | Потоков | Таймаут | Время | Скорость |
|---------|---------|---------|-------|----------|
| 50 | 10 | 3s | 45s | 1.1/s |
| 500 | 50 | 5s | ~8-10 мин | ~1/s |
| 10,171 | 100 | 3s | ~3-4 часа | ~1/s |

**Факторы влияющие на скорость:**
- Скорость интернета
- Географическое расположение серверов
- Загруженность DNS серверов
- Таймауты на недоступных доменах

### Оптимизация

**Увеличить скорость:**
- Больше потоков (`--threads 100-200`)
- Меньше таймаут (`--timeout 2-3`)
- Риск: больше false negatives (пропущенные рабочие домены)

**Увеличить точность:**
- Меньше потоков (`--threads 20-30`)
- Больше таймаут (`--timeout 10-15`)
- Риск: медленнее проверка

## Расширенная валидация (опционально)

### Установка дополнительных библиотек

```bash
pip install -r requirements_domain_validation.txt
```

**Дополнительные возможности:**
- `dnspython` - расширенная DNS проверка (MX, NS, CNAME записи)
- `python-whois` - проверка регистрации домена и даты истечения
- `aiohttp` - асинхронные запросы (в 5-10 раз быстрее)
- `tqdm` - красивый прогресс бар

### Планы развития

Будущие возможности (TODO):
- [ ] Асинхронная версия скрипта (aiohttp)
- [ ] WHOIS проверка с датой истечения
- [ ] MX записи для email валидации
- [ ] SSL сертификат проверка
- [ ] Geo-IP определение страны сервера
- [ ] Blacklist проверка (спам базы)

## Использование результатов

### Парсинг только валидных доменов

```bash
# 1. Валидация доменов
python validate_domains.py output/POST_SOVIET_DOMAINS_NO_METADATA.txt

# 2. Парсинг метаданных только для валидных доменов
python parse_metadata.py output/domain_validation/VALID_DOMAINS_*.txt

# 3. Обогащение базы данных
python email_enricher.py --domains output/domain_validation/VALID_DOMAINS_*.txt
```

### Приоритизация парсинга

**Стратегия 1: HTTPS сначала** (самые надежные)
```bash
# Фильтруем только HTTPS домены из CSV
awk -F',' '$5=="True" {print $1}' VALIDATION_DETAILS_*.csv > HTTPS_ONLY.txt
```

**Стратегия 2: По зонам** (отдельно .ru, .by, .kz)
```bash
# Только .ru домены
grep '\.ru$' VALID_DOMAINS_*.txt > VALID_RU_ONLY.txt
```

## Troubleshooting

### Проблема: Слишком медленно

**Решение:**
```bash
# Увеличьте потоки и уменьшите таймаут
python validate_domains.py ... --threads 200 --timeout 2
```

### Проблема: Много ложных отрицаний (valid домены отмечены как invalid)

**Решение:**
```bash
# Увеличьте таймаут
python validate_domains.py ... --timeout 10
```

### Проблема: DNS errors / Connection refused

**Возможные причины:**
- Проблемы с интернетом
- Блокировка со стороны провайдера
- DNS сервер перегружен

**Решение:**
- Попробуйте другой DNS сервер (Google DNS 8.8.8.8)
- Используйте VPN
- Уменьшите количество потоков

## Примеры использования

### Пример 1: Быстрая проверка топ-100

```bash
python validate_domains.py output/POST_SOVIET_DOMAINS_NO_METADATA.txt \
    --limit 100 \
    --threads 20 \
    --timeout 5
```

### Пример 2: Полная проверка с оптимальными настройками

```bash
python validate_domains.py output/POST_SOVIET_DOMAINS_NO_METADATA.txt \
    --threads 100 \
    --timeout 3 \
    --output-dir output/full_validation
```

### Пример 3: Консервативная проверка (для медленных серверов)

```bash
python validate_domains.py output/POST_SOVIET_DOMAINS_NO_METADATA.txt \
    --threads 10 \
    --timeout 15
```

## FAQ

**Q: Сколько времени займет проверка 10,171 доменов?**
A: При стандартных настройках (~1 домен/сек) - около 3 часов. При оптимизированных настройках - 1-2 часа.

**Q: Можно ли прервать проверку и продолжить потом?**
A: Нет, но можно обрабатывать файл по частям используя `--limit`.

**Q: Что делать с доменами где DNS OK, но HTTP недоступен?**
A: Это парковочные домены или домены в процессе миграции. Можно попробовать проверить позже.

**Q: Безопасно ли делать столько HTTP запросов?**
A: Да, мы делаем только HEAD/GET запросы с таймаутами. Но некоторые сайты могут временно заблокировать ваш IP при агрессивном парсинге.

**Q: Нужны ли sudo/admin права?**
A: Нет, скрипт использует только стандартные библиотеки Python.
